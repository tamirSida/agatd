<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>המוצרים המועדפים שלי - AGAT&D</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="icon" href="images/logo.png" type="image/png">
  <style>
    /* Favorites page styles */
    .favorites-container {
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    
    .favorites-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #eee;
    }
    
    .favorites-title {
      margin: 0;
      font-size: 24px;
      color: #333;
    }
    
    .back-button {
      display: inline-block;
      padding: 8px 15px;
      background-color: #f1f1f1;
      color: #333;
      text-decoration: none;
      border-radius: 4px;
    }
    
    .back-button:hover {
      background-color: #ddd;
    }
    
    .product-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .product-card {
      border: 1px solid #eee;
      border-radius: 8px;
      padding: 15px;
      background-color: white;
      transition: transform 0.3s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    .product-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
    
    .product-image {
      position: relative;
      height: 200px;
      margin-bottom: 15px;
    }
    
    .product-image img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    
    .product-info h3 {
      margin-top: 0;
      margin-bottom: 10px;
      font-size: 18px;
    }
    
    .product-company {
      color: #666;
      margin-bottom: 8px;
    }
    
    .product-country {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .country-flag {
      margin-left: 8px;
      border: 1px solid #eee;
    }
    
    .product-buttons {
      position: absolute;
      top: 10px;
      left: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      z-index: 10;
    }
    
    .heart-button, .cart-button {
      background: white;
      border: none;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      cursor: pointer;
      padding: 0;
    }
    
    .heart-icon {
      font-size: 22px;
      color: #e74c3c;
      font-style: normal;
    }
    
    .cart-icon {
      font-size: 18px;
      color: #27ae60;
      font-style: normal;
    }
    
    .heart-button.liked .heart-icon {
      color: #e74c3c;
    }
    
    /* Toast message styles */
    .toast-message {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background-color: rgba(39, 174, 96, 0.9);
      color: white;
      padding: 12px 20px;
      border-radius: 4px;
      font-size: 16px;
      z-index: 1000;
      transition: transform 0.3s ease;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
    }
    
    .toast-message.show {
      transform: translateX(-50%) translateY(0);
    }
    
    .image-not-found {
      display: none;
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.6);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
    }
    
    .product-details {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 10px;
    }
    
    .barcode {
      color: #999;
      font-size: 12px;
    }
    
    .price {
      background-color: #f8f9fa;
      padding: 4px 8px;
      border-radius: 4px;
      font-weight: bold;
    }
    
    .kosher-tags {
      display: flex;
      gap: 5px;
      margin-bottom: 10px;
    }
    
    .kosher-status {
      font-size: 12px;
      padding: 3px 6px;
      border-radius: 3px;
      font-weight: bold;
    }
    
    .kosher-yes {
      background-color: #e8f5e9;
      color: #2e7d32;
    }
    
    .kosher-no {
      background-color: #ffebee;
      color: #c62828;
    }
    
    .kosher-passover {
      background-color: #e3f2fd;
      color: #1565c0;
    }
    
    .no-products {
      text-align: center;
      padding: 50px 20px;
      background-color: #f8f9fa;
      border-radius: 8px;
      margin-top: 20px;
    }
    
    .no-products h3 {
      margin-top: 0;
      color: #555;
    }
    
    .no-products p {
      color: #777;
      margin-bottom: 20px;
    }
    
    .browse-button {
      display: inline-block;
      padding: 10px 20px;
      background-color: #3498db;
      color: white;
      text-decoration: none;
      border-radius: 4px;
      font-weight: bold;
    }
    
    .browse-button:hover {
      background-color: #2980b9;
    }
    
    /* Loading spinner */
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-top-color: #3498db;
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
    
    /* Auth styles */
    .auth-container {
      position: absolute;
      top: 20px;
      left: 20px;
      display: flex;
      align-items: center;
    }
    
    .auth-button {
      background-color: #3498db;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .auth-button:hover {
      background-color: #2980b9;
    }
    
    .user-info {
      margin-right: 10px;
      display: none;
    }
    
    .logout-button {
      background-color: #e74c3c;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      margin-right: 10px;
      display: none;
    }
    
    .logout-button:hover {
      background-color: #c0392b;
    }
    
    .admin-button {
      background-color: #27ae60;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      margin-right: 10px;
      display: none;
    }
    
    .admin-button:hover {
      background-color: #2ecc71;
    }
    
    .agent-button {
      background-color: #f39c12;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      margin-right: 10px;
      display: none;
    }
    
    .agent-button:hover {
      background-color: #f1c40f;
    }
  </style>
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
  <header>
    <div class="logo-container">
      <img src="images/logo.png" alt="Logo" class="company-logo">
    </div>
    <div class="auth-container">
      <div class="user-info" id="user-info"></div>
      <button class="admin-button" id="admin-button">ניהול</button>
      <button class="agent-button" id="agent-button">דאשבורד סוכן</button>
      <button class="logout-button" id="logout-button">התנתק</button>
      <button class="auth-button" id="login-button">התחבר</button>
    </div>
    <h1>המוצרים המועדפים שלי</h1>
    
    <!-- Navigation -->
    <div style="margin-bottom: 15px; text-align: right;">
      <a href="new-products.html" style="display: inline-block; padding: 5px 15px; margin-left: 10px; text-decoration: none; color: #3498db; border: 1px solid #3498db; border-radius: 4px;">למוצרים חדשים</a>
    </div>
  </header>

  <main>
    <div class="favorites-container">
      <div class="favorites-header">
        <h2 class="favorites-title">המוצרים שסימנתי כמועדפים</h2>
        <div>
          <a href="index.html" class="back-button">חזרה לקטלוג</a>
        </div>
      </div>
      
      <div id="favorites-content">
        <div id="loading" style="text-align: center; padding: 30px;">
          <div class="spinner"></div>
          <p>טוען מוצרים מועדפים...</p>
        </div>
        
        <div id="product-grid" class="product-grid" style="display: none;">
          <!-- Will be populated by JavaScript -->
        </div>
        
        <div id="no-favorites" class="no-products" style="display: none;">
          <h3>אין לך מוצרים מועדפים עדיין</h3>
          <p>סמן מוצרים כמועדפים בעזרת לחיצה על אייקון הלב בעמוד הקטלוג</p>
          <a href="index.html" class="browse-button">עבור לקטלוג המוצרים</a>
        </div>
      </div>
    </div>
  </main>

  <!-- Product Modal -->
  <div id="product-modal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <div class="modal-header">
        <h2 id="modal-product-title">שם מוצר</h2>
        <div id="modal-product-company">שם חברה</div>
      </div>
      <div class="modal-body">
        <div class="modal-image">
          <img id="modal-product-image" src="placeholder.jpg" alt="Product Image">
          <div class="modal-image-not-found">image not found</div>
        </div>
        <div class="modal-details">
          <p id="modal-product-description">תיאור המוצר...</p>
          <div id="modal-product-specs"></div>
          <div id="modal-product-variants"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  
  <!-- Config -->
  <script src="firebase-config.js"></script>
  
  <!-- Auth Manager -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const userInfoElement = document.getElementById('user-info');
      const loginButton = document.getElementById('login-button');
      const logoutButton = document.getElementById('logout-button');
      const adminButton = document.getElementById('admin-button');
      const agentButton = document.getElementById('agent-button');
      
      // Handle login button click
      loginButton.addEventListener('click', () => {
        window.location.href = 'login.html';
      });
      
      // Handle admin button click
      adminButton.addEventListener('click', () => {
        window.location.href = 'admin.html';
      });
      
      // Handle agent button click
      agentButton.addEventListener('click', () => {
        window.location.href = 'agent.html';
      });
      
      // Handle logout button click
      logoutButton.addEventListener('click', async () => {
        try {
          await auth.signOut();
          window.location.reload();
        } catch (error) {
          console.error('Logout error:', error);
        }
      });
      
      // Listen for auth state changes
      auth.onAuthStateChanged(async (user) => {
        if (user) {
          // User is signed in
          userInfoElement.style.display = 'block';
          userInfoElement.textContent = user.email;
          
          logoutButton.style.display = 'block';
          loginButton.style.display = 'none';
          
          // Get user role from Firestore
          try {
            const userDoc = await db.collection('users').doc(user.uid).get();
            
            if (userDoc.exists) {
              const userData = userDoc.data();
              
              // Show role-specific buttons
              if (userData.role === USER_ROLES.ADMIN) {
                adminButton.style.display = 'block';
              } else if (userData.role === USER_ROLES.AGENT) {
                agentButton.style.display = 'block';
              } else if (userData.role !== USER_ROLES.CLIENT) {
                // Redirect non-client users back to catalog
                alert('רק ללקוחות יש גישה לדף המועדפים');
                window.location.href = 'index.html';
                return;
              } else if (userData.role === USER_ROLES.CLIENT) {
                // Add cart button to header for clients
                const authContainer = document.querySelector('.auth-container');
                if (authContainer) {
                  // Create cart button
                  const cartButton = document.createElement('button');
                  cartButton.id = 'cart-button-header';
                  cartButton.className = 'cart-button-header';
                  cartButton.innerHTML = '<i class="fas fa-shopping-cart"></i> עגלת קניות';
                  cartButton.style.backgroundColor = '#27ae60';
                  cartButton.style.color = 'white';
                  cartButton.style.border = 'none';
                  cartButton.style.padding = '6px 12px';
                  cartButton.style.borderRadius = '4px';
                  cartButton.style.cursor = 'pointer';
                  cartButton.style.fontSize = '12px';
                  cartButton.style.marginRight = '10px';
                  
                  // Add event listener
                  cartButton.addEventListener('click', () => {
                    window.location.href = 'shopping-cart.html';
                  });
                  
                  // Add cart count badge
                  const cartCountBadge = document.createElement('span');
                  cartCountBadge.id = 'cart-count-badge';
                  cartCountBadge.className = 'cart-count-badge';
                  cartCountBadge.textContent = '0';
                  cartCountBadge.style.position = 'absolute';
                  cartCountBadge.style.top = '-8px';
                  cartCountBadge.style.right = '-8px';
                  cartCountBadge.style.backgroundColor = '#e74c3c';
                  cartCountBadge.style.color = 'white';
                  cartCountBadge.style.borderRadius = '50%';
                  cartCountBadge.style.width = '20px';
                  cartCountBadge.style.height = '20px';
                  cartCountBadge.style.display = 'flex';
                  cartCountBadge.style.justifyContent = 'center';
                  cartCountBadge.style.alignItems = 'center';
                  cartCountBadge.style.fontSize = '12px';
                  cartCountBadge.style.fontWeight = 'bold';
                  
                  // Insert after favorites button
                  cartButton.style.position = 'relative';
                  cartButton.appendChild(cartCountBadge);
                  authContainer.insertBefore(cartButton, logoutButton);
                  
                  // Update cart count
                  getUserCart().then(cart => {
                    const count = cart.length;
                    cartCountBadge.textContent = count.toString();
                    cartCountBadge.style.display = count > 0 ? 'flex' : 'none';
                  });
                }
              }
              
              // Store user role in window object for global access
              window.userRole = userData.role;
            }
            
            // Load user's favorite products
            // Elements will be initialized in the loadFavoriteProducts function
            loadFavoriteProducts(user.uid);
            
          } catch (error) {
            console.error('Error getting user data:', error);
          }
        } else {
          // User is signed out, redirect to login
          window.location.href = 'login.html';
        }
      });
    });
  </script>
  
  <!-- Favorites Logic -->
  <script>
    // Global variables
    let favoriteProducts = [];
    let productCache = {};
    
    // DOM elements - will be initialized in DOMContentLoaded
    let productGrid;
    let loadingElement;
    let noFavoritesElement;
    let modal;
    let closeModalBtn;
    let modalTitle;
    let modalCompany;
    let modalImage;
    let modalDescription;
    let modalSpecs;
    let modalVariants;
    
    // Show no favorites message
    function showNoFavorites() {
      if (loadingElement) loadingElement.style.display = 'none';
      if (productGrid) productGrid.style.display = 'none';
      if (noFavoritesElement) {
        noFavoritesElement.style.display = 'block';
      }
    }
    
    // Show error message
    function showError(message) {
      if (loadingElement) loadingElement.style.display = 'none';
      if (productGrid) productGrid.style.display = 'none';
      if (noFavoritesElement) {
        noFavoritesElement.style.display = 'block';
        noFavoritesElement.innerHTML = `
          <h3>שגיאה</h3>
          <p>${message}</p>
          <a href="index.html" class="browse-button">חזרה לקטלוג המוצרים</a>
        `;
      }
    }
    
    // Initialize DOM elements - called once page is loaded
    function initializeElements() {
      productGrid = document.getElementById('product-grid');
      loadingElement = document.getElementById('loading');
      noFavoritesElement = document.getElementById('no-favorites');
      modal = document.getElementById('product-modal');
      closeModalBtn = document.querySelector('.close');
      modalTitle = document.getElementById('modal-product-title');
      modalCompany = document.getElementById('modal-product-company');
      modalImage = document.getElementById('modal-product-image');
      modalDescription = document.getElementById('modal-product-description');
      modalSpecs = document.getElementById('modal-product-specs');
      modalVariants = document.getElementById('modal-product-variants');
    }
    
    // CSV URLs for each product category
    const ALCOHOL_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRGNZzh1kbP8nYSiVNDDsd198zJoo6725-WKPz7YUE-lVWXkdjn0r97SJAEOttnLoqAH5PSJRbDbRiB/pub?output=csv';
    const WINE_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRkUmKUxQGkMSoLEhfkgdXBU6KGDDea6Z8crHPVeFEsYajhCUmSQevyTL_9WucAyhw2UnDfoFQXURCB/pub?output=csv';
    const BEER_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQGFPOHiYkWGPDASiBePqXkbxoikcLYiFAz1RobyVTlX2-dj71jMSCCFLgrNXOjFpOZYwS7MHCD6IrU/pub?output=csv';
    const FOOD_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS5zrZyn-cmKHuk3H-nI4QG9NDJFvB-q3MjjdIUuQfk_lhtQPzTeovn_kAz46o2PnuH_aZ8Mq1zteFD/pub?output=csv';
    const WHISKEY_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSnSgqeW3W-2vKiqPwsBLpOE9vamrHELbgZCNHDYv6bGGYPnkhp44KzYvbly7qCLq3E_Rgu2VyYKMGY/pub?output=csv';
    
    // Load favorite products for the user
    async function loadFavoriteProducts(userId) {
      try {
        // Initialize DOM elements first
        initializeElements();
        
        // Show loading indicator
        if (loadingElement) {
          loadingElement.style.display = 'block';
        }
        if (productGrid) {
          productGrid.style.display = 'none';
        }
        if (noFavoritesElement) {
          noFavoritesElement.style.display = 'none';
        }
        
        // Get user's liked products
        const clientDoc = await db.collection('clients').doc(userId).get();
        if (!clientDoc.exists) {
          console.error('Client document not found');
          showNoFavorites();
          return;
        }
        
        const likes = clientDoc.data().likes || [];
        console.log('User likes:', likes);
        
        if (likes.length === 0) {
          showNoFavorites();
          return;
        }
        
        // Load product data from all sources
        await loadProductData();
        
        // Filter out only liked products
        favoriteProducts = [];
        for (const barcode of likes) {
          const product = productCache[barcode];
          if (product) {
            favoriteProducts.push(product);
          }
        }
        
        if (favoriteProducts.length === 0) {
          showNoFavorites();
          return;
        }
        
        // Display favorite products
        displayFavoriteProducts();
        
      } catch (error) {
        console.error('Error loading favorite products:', error);
        showError('שגיאה בטעינת מוצרים מועדפים');
      }
    }
    
    // Load product data from all sources
    async function loadProductData() {
      try {
        const sources = [
          { url: ALCOHOL_CSV_URL, name: 'alcohol' },
          { url: WINE_CSV_URL, name: 'wine' },
          { url: BEER_CSV_URL, name: 'beer' },
          { url: FOOD_CSV_URL, name: 'food' },
          { url: WHISKEY_CSV_URL, name: 'whiskey' }
        ];
        
        // Load all data sources concurrently
        const results = await Promise.allSettled(sources.map(source => 
          fetch(source.url)
            .then(response => response.text())
            .then(text => ({ data: parseCSV(text), source: source.name }))
        ));
        
        // Process results and populate cache
        results.forEach(result => {
          if (result.status === 'fulfilled') {
            const products = result.value.data;
            products.forEach(product => {
              const barcode = product['ברקוד'];
              if (barcode) {
                product.source = result.value.source;
                productCache[barcode] = product;
              }
            });
          }
        });
        
        console.log('Loaded product data:', Object.keys(productCache).length, 'products');
        
      } catch (error) {
        console.error('Error loading product data:', error);
        throw error;
      }
    }
    
    // Parse CSV text to array of objects
    function parseCSV(csvText) {
      // Remove potential BOM character
      if (csvText.charCodeAt(0) === 0xFEFF) {
        csvText = csvText.slice(1);
      }
    
      const lines = csvText.split('\n');
      // Don't lowercase headers - preserve original case
      const headers = lines[0].split(',').map(header => header.trim());
      
      return lines.slice(1)
        .filter(line => line.trim())
        .map(line => {
          // Handle quoted fields with commas
          const values = [];
          let currentValue = '';
          let insideQuotes = false;
    
          for (let char of line) {
            if (char === '"') {
              insideQuotes = !insideQuotes;
            } else if (char === ',' && !insideQuotes) {
              values.push(currentValue.trim());
              currentValue = '';
            } else {
              currentValue += char;
            }
          }
          values.push(currentValue.trim()); // Add the last value
    
          // Create object with header keys
          const product = {};
          headers.forEach((header, index) => {
            // Normalize the header to handle encoding issues
            const normalizedHeader = header.normalize('NFKC').replace(/\s+/g, ' ');
            product[normalizedHeader] = values[index] || '';
            // Clean quotes
            if (typeof product[normalizedHeader] === 'string') {
              product[normalizedHeader] = product[normalizedHeader].replace(/"/g, '');
            }
          });
    
          return product;
        })
        .filter(product => {
          // Filter out invalid products that don't have essential data
          // A product must have at least a name (from either field) to be valid
          return (product['שם פריט אוטומטי'] && product['שם פריט אוטומטי'].trim() !== '') || 
                 (product['תיאור פריט'] && product['תיאור פריט'].trim() !== '');
        });
    }
    
    // Display favorite products
    function displayFavoriteProducts() {
      // Hide loading indicator
      loadingElement.style.display = 'none';
      noFavoritesElement.style.display = 'none';
      
      // Clear product grid
      productGrid.innerHTML = '';
      
      // Show product grid
      productGrid.style.display = 'grid';
      
      // Create product cards
      favoriteProducts.forEach(product => {
        const card = createProductCard(product);
        productGrid.appendChild(card);
      });
    }
    
    // Create product card element
    function createProductCard(product) {
      const barcode = product['ברקוד'];
      const productType = product.source || 'alcohol';
      
      // Get product name from appropriate field based on product type
      let productName = '';
      if (productType === 'whiskey') {
        productName = product['תיאור פריט'] || product['שם פריט אוטומטי'] || '';
      } else {
        productName = product['שם פריט אוטומטי'] || product['תיאור פריט'] || '';
      }
      
      // Get image URL based on barcode
      const imageUrl = barcode ? `tl/${barcode}.jpg` : 'placeholder.jpg';
      
      // Get company/brand name from appropriate field
      const company = product['קבוצה / מותג'] || product['קבוצה / מותג אוטומטי'] || product['מותג'] || '';
      
      // Create card element
      const card = document.createElement('div');
      card.className = 'product-card';
      
      // Get country code for flag
      const countryToCode = {
        'ישראל': 'il',
        'איטליה': 'it',
        'צרפת': 'fr',
        'גרמניה': 'de',
        'ספרד': 'es',
        'ארה"ב': 'us',
        'בריטניה': 'gb',
        'סין': 'cn',
        'יפן': 'jp',
        'הודו': 'in',
        'ברזיל': 'br',
        'אוסטרליה': 'au',
        'קנדה': 'ca',
        'רוסיה': 'ru',
        'טורקיה': 'tr',
        'מולדובה': 'md',
        'גאורגיה': 'ge',
        'איחוד האמירויות': 'ae',
        'אוקראינה': 'ua',
        'פולין': 'pl',
        'בולגריה': 'bg',
        'גואטמאלה': 'gt',
        'מקסיקו': 'mx',
        'סנט לוסיה': 'lc',
        'קולומביה': 'co',
        'קאריבים': 'bs', // Using Bahamas as generic Caribbean flag
        'יוון': 'gr',
        'סקוטלנד': 'gb', // Using UK flag for Scotland
        'מלטה': 'mt',
        'קניה': 'ke',
        'סלובניה': 'si'
      };
      
      const countryCode = product['מדינה'] && countryToCode[product['מדינה']] ? countryToCode[product['מדינה']] : '';
      
      // Kosher status
      let kosherHtml = '';
      if (product['כשרות']) {
        const kosherValue = product['כשרות'].toString().trim().toLowerCase();
        if (kosherValue === 'true' || kosherValue === 'כן' || kosherValue === 'כשר') {
          kosherHtml = '<div class="kosher-status kosher-yes">כשר</div>';
        } else if (kosherValue === 'false' || kosherValue === 'לא' || kosherValue === 'לא כשר') {
          kosherHtml = '<div class="kosher-status kosher-no">לא כשר</div>';
        }
      }
      
      // Build card HTML
      card.innerHTML = `
        <div class="product-image">
          <img src="${imageUrl}" alt="${productName}" onerror="if(this.src.includes('tl/')){ this.src='media/${barcode || ''}.jpg'; } else if(this.src.includes('media/')){ this.src='images/logo.png'; this.nextElementSibling.style.display='block'; }">
          <div class="image-not-found">image not found</div>
          <div class="product-buttons">
            <button class="heart-button liked" data-barcode="${barcode || ''}"><i class="fas fa-heart"></i></button>
            <button class="cart-button" data-barcode="${barcode || ''}" data-product-name="${productName.replace(/"/g, '&quot;')}" data-price="${product['מחיר'] || '0'}" data-pricelist="${product['מחירון'] || ''}"><i class="fas fa-shopping-cart"></i></button>
          </div>
        </div>
        <div class="product-info">
          <h3>${productName}</h3>
          ${company ? `<div class="product-company">${company}</div>` : ''}
          ${product['מדינה'] ? `<div class="product-country">
            ${countryCode ? `<img class="country-flag" src="https://flagcdn.com/24x18/${countryCode}.png" alt="${product['מדינה']} flag">` : ''}
            <span class="country-name">${product['מדינה']}</span>
          </div>` : ''}
          <div class="kosher-tags">
            ${kosherHtml}
          </div>
          <div class="product-details">
            ${barcode ? `<span class="barcode">${barcode}</span>` : ''}
          </div>
        </div>
      `;
      
      // Add click event to open modal
      card.addEventListener('click', (e) => {
        // Don't open modal if heart button or cart button was clicked
        if (
          e.target.closest('.heart-button') || 
          e.target.classList.contains('heart-icon') ||
          e.target.closest('.cart-button') || 
          e.target.classList.contains('cart-icon')
        ) {
          e.stopPropagation();
          return;
        }
        openProductModal(product);
      });
      
      // Add heart button click event
      const heartButton = card.querySelector('.heart-button');
      if (heartButton) {
        heartButton.addEventListener('click', async (e) => {
          e.stopPropagation(); // Prevent modal from opening
          
          const barcode = heartButton.dataset.barcode;
          
          if (!barcode) {
            console.error('No barcode found for product');
            return;
          }
          
          try {
            // Remove from likes
            await toggleProductLike(barcode);
            
            // Remove card from grid with animation
            card.style.opacity = '0';
            card.style.transform = 'scale(0.8)';
            card.style.transition = 'opacity 0.3s, transform 0.3s';
            
            setTimeout(() => {
              card.remove();
              
              // Check if grid is empty
              if (productGrid.children.length === 0) {
                showNoFavorites();
              }
            }, 300);
            
          } catch (error) {
            console.error('Error removing like:', error);
            alert('שגיאה בהסרת מוצר מהמועדפים. אנא נסה שוב מאוחר יותר.');
          }
        });
      }
      
      // Add cart button click event
      const cartButton = card.querySelector('.cart-button');
      if (cartButton) {
        cartButton.addEventListener('click', async (e) => {
          e.stopPropagation(); // Prevent modal from opening
          
          const barcode = cartButton.dataset.barcode;
          const productName = cartButton.dataset.productName;
          const price = cartButton.dataset.price;
          
          if (!barcode) {
            console.error('No barcode found for product');
            return;
          }
          
          // Show quantity prompt modal
          const quantity = await showQuantityPrompt(productName);
          
          // If quantity is undefined or null, it means the user cancelled
          if (quantity === undefined || quantity === null) {
            return;
          }
          
          try {
            // Add to cart in Firebase with selected quantity
            const success = await addToCart({
              barcode: barcode,
              name: productName,
              price: parseFloat(price) || 0,
              מחירון: cartButton.dataset.pricelist || null,
              category: product.source || 'alcohol'
            }, quantity);
            
            if (success) {
              // Show success message
              const toastMessage = document.createElement('div');
              toastMessage.className = 'toast-message';
              toastMessage.textContent = `${quantity} יחידות נוספו לעגלה בהצלחה`;
              document.body.appendChild(toastMessage);
              
              // Animate toast message
              setTimeout(() => {
                toastMessage.classList.add('show');
                
                setTimeout(() => {
                  toastMessage.classList.remove('show');
                  setTimeout(() => {
                    document.body.removeChild(toastMessage);
                  }, 300);
                }, 2000);
              }, 100);
            } else {
              console.error('Failed to add product to cart');
            }
          } catch (error) {
            console.error('Error adding to cart:', error);
            alert('שגיאה בהוספת המוצר לעגלה. אנא נסה שוב מאוחר יותר.');
          }
        });
      }
      
      return card;
    }
    
    // Open product modal
    function openProductModal(product) {
      // Set modal content based on product type
      const productType = product.source || 'alcohol';
      if (productType === 'whiskey') {
        modalTitle.textContent = product['תיאור פריט'] || product['שם פריט אוטומטי'] || 'Unnamed Product';
      } else {
        modalTitle.textContent = product['שם פריט אוטומטי'] || product['תיאור פריט'] || 'Unnamed Product';
      }
      
      // Set company
      const company = product['קבוצה / מותג'] || product['קבוצה / מותג אוטומטי'] || product['מותג'] || '';
      modalCompany.textContent = company;
      
      // Set description
      modalDescription.textContent = product['תאור'] || '';
      
      // Set image
      const barcode = product['ברקוד'];
      const imageUrl = barcode ? `tl/${barcode}.jpg` : 'placeholder.jpg';
      modalImage.src = imageUrl;
      modalImage.alt = product['שם פריט אוטומטי'] || 'Product';
      
      // Reset the image not found message
      document.querySelector('.modal-image-not-found').style.display = 'none';
      
      // Handle image error - try alternative folders before showing error
      modalImage.onerror = function() {
        if (this.src.includes('tl/')) {
          // If tl/ folder failed, try media/ folder
          this.src = `media/${barcode}.jpg`;
        } else if (this.src.includes('media/')) {
          // If media/ folder also failed, use placeholder and show error
          this.src = 'placeholder.jpg';
          document.querySelector('.modal-image-not-found').style.display = 'block';
        }
      };
      
      // Clear specs
      modalSpecs.innerHTML = '';
      modalVariants.innerHTML = '';
      
      // Add country with flag to specs
      if (product['מדינה']) {
        const countryToCode = {
          'ישראל': 'il',
          'איטליה': 'it',
          'צרפת': 'fr',
          'גרמניה': 'de',
          'ספרד': 'es',
          'ארה"ב': 'us',
          'בריטניה': 'gb',
          'סין': 'cn',
          'יפן': 'jp',
          'הודו': 'in',
          'ברזיל': 'br',
          'אוסטרליה': 'au',
          'קנדה': 'ca',
          'רוסיה': 'ru',
          'טורקיה': 'tr',
          'מולדובה': 'md',
          'גאורגיה': 'ge',
          'איחוד האמירויות': 'ae',
          'אוקראינה': 'ua',
          'פולין': 'pl',
          'בולגריה': 'bg',
          'גואטמאלה': 'gt',
          'מקסיקו': 'mx',
          'סנט לוסיה': 'lc',
          'קולומביה': 'co',
          'קאריבים': 'bs',
          'יוון': 'gr',
          'סקוטלנד': 'gb',
          'מלטה': 'mt',
          'קניה': 'ke',
          'סלובניה': 'si'
        };
        
        const countryCode = countryToCode[product['מדינה']] || '';
        const countrySpec = document.createElement('div');
        countrySpec.className = 'spec-item country-spec';
        countrySpec.innerHTML = `
          <div class="spec-label"><strong>מדינת ייצור</strong>:</div>
          <div class="spec-value">
            ${countryCode ? `<img class="country-flag" src="https://flagcdn.com/24x18/${countryCode}.png" alt="${product['מדינה']} flag">` : ''}
            <span class="country-name">${product['מדינה']}</span>
          </div>
        `;
        modalSpecs.appendChild(countrySpec);
      }
      
      // Add kosher status to modal
      if (product['כשרות']) {
        const kosherSpec = document.createElement('div');
        kosherSpec.className = 'spec-item';
        
        let kosherValue;
        const kosherRawValue = product['כשרות'].toString().trim().toLowerCase();
        
        if (kosherRawValue === 'true' || kosherRawValue === 'כן' || kosherRawValue === 'כשר') {
          kosherValue = '<span class="kosher-status kosher-yes">כשר</span>';
        } else if (kosherRawValue === 'false' || kosherRawValue === 'לא' || kosherRawValue === 'לא כשר') {
          kosherValue = '<span class="kosher-status kosher-no">לא כשר</span>';
        } else {
          kosherValue = product['כשרות'];
        }
        
        kosherSpec.innerHTML = `
          <div class="spec-label"><strong>כשרות</strong>:</div>
          <div class="spec-value">${kosherValue}</div>
        `;
        modalSpecs.appendChild(kosherSpec);
      }
      
      // Add product specs
      for (const [key, value] of Object.entries(product)) {
        // Skip empty values, brands, and fields displayed elsewhere
        if (!value || 
            key === 'שם פריט אוטומטי' || 
            key === 'תאור' || 
            key === 'כשרות' ||
            key === 'מדינה' ||
            key === 'company' || 
            key === 'קבוצה / מותג' || 
            key === 'קבוצה / מותג אוטומטי' ||
            key === 'source' ||
            (typeof value === 'string' && 
             (value.trim().toUpperCase() === 'TRUE' || 
              value.trim().toUpperCase() === 'FALSE'))) continue;
        
        const specItem = document.createElement('div');
        specItem.className = 'spec-item';
        
        specItem.innerHTML = `
          <div class="spec-label"><strong>${key}</strong>:</div>
          <div class="spec-value">${value}</div>
        `;
        
        modalSpecs.appendChild(specItem);
      }
      
      // Add heart button to modal
      let modalHeartButton = document.querySelector('.modal-heart-button');
      
      if (!modalHeartButton) {
        modalHeartButton = document.createElement('button');
        modalHeartButton.className = 'modal-heart-button liked';
        modalHeartButton.innerHTML = `<i class="fas fa-heart"></i>`;
        modalHeartButton.dataset.barcode = barcode || '';
        
        document.querySelector('.modal-header').appendChild(modalHeartButton);
        
        // Add event listener to heart button
        modalHeartButton.addEventListener('click', async function() {
          const barcode = this.dataset.barcode;
          
          if (!barcode) {
            console.error('No barcode found for product');
            return;
          }
          
          try {
            // Toggle like in Firebase
            await toggleProductLike(barcode);
            
            // Close modal
            closeProductModal();
            
            // Reload the page to refresh the favorites list
            window.location.reload();
            
          } catch (error) {
            console.error('Error toggling like:', error);
            alert('שגיאה בעדכון המועדפים. אנא נסה שוב מאוחר יותר.');
          }
        });
      } else {
        // Update existing heart button
        modalHeartButton.dataset.barcode = barcode || '';
        modalHeartButton.classList.add('liked');
        modalHeartButton.querySelector('.fa-heart').className = 'fas fa-heart';
      }
      
      // Add cart button to modal
      let modalCartButton = document.querySelector('.modal-cart-button');
      if (!modalCartButton) {
        modalCartButton = document.createElement('button');
        modalCartButton.className = 'modal-cart-button';
        modalCartButton.innerHTML = `<i class="fas fa-shopping-cart"></i>`;
        modalCartButton.dataset.barcode = barcode || '';
        modalCartButton.dataset.productName = modalTitle.textContent;
        modalCartButton.dataset.price = product['מחיר'] || '0';
        modalCartButton.dataset.pricelist = product['מחירון'] || '';
        modalCartButton.style.position = 'absolute';
        modalCartButton.style.right = '40px';
        modalCartButton.style.top = '10px';
        modalCartButton.style.background = 'white';
        modalCartButton.style.border = 'none';
        modalCartButton.style.borderRadius = '50%';
        modalCartButton.style.width = '36px';
        modalCartButton.style.height = '36px';
        modalCartButton.style.display = 'flex';
        modalCartButton.style.alignItems = 'center';
        modalCartButton.style.justifyContent = 'center';
        modalCartButton.style.boxShadow = '0 2px 4px rgba(0, 0, 0, 0.2)';
        modalCartButton.style.cursor = 'pointer';
        modalCartButton.style.zIndex = '10';
        
        document.querySelector('.modal-header').appendChild(modalCartButton);
        
        // Add event listener to cart button
        modalCartButton.addEventListener('click', async function() {
          const barcode = this.dataset.barcode;
          const productName = this.dataset.productName;
          const price = this.dataset.price;
          
          if (!barcode) {
            console.error('No barcode found for product');
            return;
          }
          
          // Show quantity prompt modal
          const quantity = await showQuantityPrompt(productName);
          
          // If quantity is undefined or null, it means the user cancelled
          if (quantity === undefined || quantity === null) {
            return;
          }
          
          try {
            // Add to cart in Firebase with selected quantity
            const success = await addToCart({
              barcode: barcode,
              name: productName,
              price: parseFloat(price) || 0,
              מחירון: this.dataset.pricelist || null,
              category: product.source || 'alcohol'
            }, quantity);
            
            if (success) {
              // Close modal
              closeProductModal();
              
              // Show success message
              const toastMessage = document.createElement('div');
              toastMessage.className = 'toast-message';
              toastMessage.textContent = `${quantity} יחידות נוספו לעגלה בהצלחה`;
              document.body.appendChild(toastMessage);
              
              // Animate toast message
              setTimeout(() => {
                toastMessage.classList.add('show');
                
                setTimeout(() => {
                  toastMessage.classList.remove('show');
                  setTimeout(() => {
                    document.body.removeChild(toastMessage);
                  }, 300);
                }, 2000);
              }, 100);
            } else {
              console.error('Failed to add product to cart');
            }
          } catch (error) {
            console.error('Error adding to cart:', error);
            alert('שגיאה בהוספת המוצר לעגלה. אנא נסה שוב מאוחר יותר.');
          }
        });
      } else {
        // Update existing cart button
        modalCartButton.dataset.barcode = barcode || '';
        modalCartButton.dataset.productName = modalTitle.textContent;
        modalCartButton.dataset.price = product['מחיר'] || '0';
        modalCartButton.dataset.pricelist = product['מחירון'] || '';
      }
      
      // Show modal
      modal.style.display = 'block';
      document.body.style.overflow = 'hidden'; // Prevent scrolling of the background
    }
    
    // Close product modal
    function closeProductModal() {
      modal.style.display = 'none';
      document.body.style.overflow = 'auto'; // Enable scrolling on body again
    }
    
    // Show quantity prompt modal for adding product to cart
    async function showQuantityPrompt(productName) {
      return new Promise((resolve) => {
        // Create modal elements
        const modal = document.createElement('div');
        modal.className = 'quantity-modal';
        modal.style.position = 'fixed';
        modal.style.zIndex = '1000';
        modal.style.top = '0';
        modal.style.left = '0';
        modal.style.width = '100%';
        modal.style.height = '100%';
        modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
        modal.style.display = 'flex';
        modal.style.justifyContent = 'center';
        modal.style.alignItems = 'center';
        
        const modalContent = document.createElement('div');
        modalContent.className = 'quantity-modal-content';
        modalContent.style.backgroundColor = '#fff';
        modalContent.style.padding = '20px';
        modalContent.style.borderRadius = '8px';
        modalContent.style.boxShadow = '0 2px 10px rgba(0, 0, 0, 0.2)';
        modalContent.style.maxWidth = '90%';
        modalContent.style.width = '400px';
        modalContent.style.textAlign = 'center';
        
        // Product name header
        const header = document.createElement('h3');
        header.textContent = productName;
        header.style.margin = '0 0 15px 0';
        
        // Title
        const title = document.createElement('p');
        title.textContent = 'בחר כמות להוספה לעגלה:';
        title.style.marginBottom = '15px';
        
        // Quantity control
        const quantityControl = document.createElement('div');
        quantityControl.style.display = 'flex';
        quantityControl.style.justifyContent = 'center';
        quantityControl.style.alignItems = 'center';
        quantityControl.style.marginBottom = '20px';
        
        const decreaseBtn = document.createElement('button');
        decreaseBtn.textContent = '-';
        decreaseBtn.style.width = '40px';
        decreaseBtn.style.height = '40px';
        decreaseBtn.style.fontSize = '20px';
        decreaseBtn.style.backgroundColor = '#f1f1f1';
        decreaseBtn.style.border = 'none';
        decreaseBtn.style.borderRadius = '50%';
        decreaseBtn.style.cursor = 'pointer';
        
        const quantityDisplay = document.createElement('span');
        quantityDisplay.textContent = '1';
        quantityDisplay.style.minWidth = '60px';
        quantityDisplay.style.fontSize = '24px';
        quantityDisplay.style.fontWeight = 'bold';
        quantityDisplay.style.margin = '0 15px';
        quantityDisplay.style.textAlign = 'center';
        
        const increaseBtn = document.createElement('button');
        increaseBtn.textContent = '+';
        increaseBtn.style.width = '40px';
        increaseBtn.style.height = '40px';
        increaseBtn.style.fontSize = '20px';
        increaseBtn.style.backgroundColor = '#f1f1f1';
        increaseBtn.style.border = 'none';
        increaseBtn.style.borderRadius = '50%';
        increaseBtn.style.cursor = 'pointer';
        
        // Buttons
        const buttonsContainer = document.createElement('div');
        buttonsContainer.style.display = 'flex';
        buttonsContainer.style.justifyContent = 'space-between';
        
        const cancelBtn = document.createElement('button');
        cancelBtn.textContent = 'ביטול';
        cancelBtn.style.padding = '10px 20px';
        cancelBtn.style.backgroundColor = '#95a5a6';
        cancelBtn.style.color = 'white';
        cancelBtn.style.border = 'none';
        cancelBtn.style.borderRadius = '4px';
        cancelBtn.style.cursor = 'pointer';
        cancelBtn.style.fontSize = '16px';
        
        const addBtn = document.createElement('button');
        addBtn.textContent = 'הוסף לעגלה';
        addBtn.style.padding = '10px 20px';
        addBtn.style.backgroundColor = '#27ae60';
        addBtn.style.color = 'white';
        addBtn.style.border = 'none';
        addBtn.style.borderRadius = '4px';
        addBtn.style.cursor = 'pointer';
        addBtn.style.fontSize = '16px';
        
        // Assemble modal
        quantityControl.appendChild(decreaseBtn);
        quantityControl.appendChild(quantityDisplay);
        quantityControl.appendChild(increaseBtn);
        
        buttonsContainer.appendChild(cancelBtn);
        buttonsContainer.appendChild(addBtn);
        
        modalContent.appendChild(header);
        modalContent.appendChild(title);
        modalContent.appendChild(quantityControl);
        modalContent.appendChild(buttonsContainer);
        
        modal.appendChild(modalContent);
        document.body.appendChild(modal);
        
        // Event listeners
        let quantity = 1;
        
        decreaseBtn.addEventListener('click', () => {
          if (quantity > 1) {
            quantity--;
            quantityDisplay.textContent = quantity.toString();
          }
        });
        
        increaseBtn.addEventListener('click', () => {
          quantity++;
          quantityDisplay.textContent = quantity.toString();
        });
        
        cancelBtn.addEventListener('click', () => {
          document.body.removeChild(modal);
          resolve(null); // Cancel
        });
        
        addBtn.addEventListener('click', () => {
          document.body.removeChild(modal);
          resolve(quantity);
        });
        
        // Close modal by clicking outside
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            document.body.removeChild(modal);
            resolve(null); // Cancel
          }
        });
      });
    }
    
    // Using the toggleProductLike function from firebase-config.js
    
    // Show message when no favorites exist
    // Set up event listeners
    document.addEventListener('DOMContentLoaded', () => {
      // Initialize DOM elements first
      initializeElements();
      
      // Close modal events
      if (closeModalBtn) {
        closeModalBtn.addEventListener('click', closeProductModal);
      }
      
      window.addEventListener('click', function(event) {
        if (event.target === modal) {
          closeProductModal();
        }
      });
      
      // Close modal with Escape key
      document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
          if (modal.style.display === 'block') {
            closeProductModal();
          }
        }
      });
    });
  </script>
</body>
</html>