<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>דאשבורד סוכן - AGAT&D</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="icon" href="images/logo.png" type="image/png">
  <style>
    /* Dashboard styles - unified with admin panel */
    .admin-container, .agent-container {
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    
    .admin-header, .agent-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #eee;
    }
    
    .admin-title, .agent-title {
      margin: 0;
      font-size: 24px;
      color: #333;
    }
    
    /* Tabs system */
    .admin-tabs, .agent-tabs {
      display: flex;
      border-bottom: 1px solid #ddd;
      margin-bottom: 20px;
    }
    
    .admin-tab, .agent-tab {
      padding: 10px 20px;
      cursor: pointer;
      background-color: #f9f9f9;
      border: 1px solid #ddd;
      border-bottom: none;
      border-radius: 4px 4px 0 0;
      margin-right: 5px;
    }
    
    .admin-tab.active, .agent-tab.active {
      background-color: #fff;
      border-bottom: 1px solid #fff;
      margin-bottom: -1px;
      font-weight: bold;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    /* Client summary cards */
    .clients-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
    }
    
    .client-card {
      padding: 15px;
      border-radius: 8px;
      background-color: #f8f9fa;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      transition: transform 0.3s ease;
    }
    
    .client-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
    
    .client-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid #e1e1e1;
    }
    
    .client-email {
      font-weight: bold;
      font-size: 18px;
      color: #333;
    }
    
    .client-name {
      font-size: 16px;
      color: #555;
      margin-top: 3px;
    }
    
    .client-stats {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
    }
    
    .stat-item {
      text-align: center;
      flex: 1;
    }
    
    .stat-number {
      font-size: 24px;
      font-weight: bold;
      color: #3498db;
    }
    
    .stat-label {
      font-size: 14px;
      color: #777;
      margin-top: 5px;
    }
    
    .btn {
      padding: 8px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.3s ease;
    }
    
    .btn-primary {
      background-color: #3498db;
      color: white;
    }
    
    .btn-primary:hover {
      background-color: #2980b9;
    }
    
    .btn-danger {
      background-color: #e74c3c;
      color: white;
    }
    
    .btn-danger:hover {
      background-color: #c0392b;
    }
    
    .btn-success {
      background-color: #2ecc71;
      color: white;
    }
    
    .btn-success:hover {
      background-color: #27ae60;
    }
    
    /* Client likes section */
    .client-likes {
      margin-top: 15px;
    }
    
    .likes-title {
      font-size: 16px;
      font-weight: bold;
      margin-bottom: 10px;
    }
    
    .likes-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
      gap: 10px;
    }
    
    .like-item {
      position: relative;
    }
    
    .like-image {
      width: 100%;
      height: 70px;
      object-fit: contain;
      border: 1px solid #eee;
      border-radius: 4px;
      background-color: white;
    }
    
    .like-tooltip {
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background-color: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 12px;
      white-space: nowrap;
      z-index: 10;
      visibility: hidden;
      opacity: 0;
      transition: visibility 0s, opacity 0.3s;
    }
    
    .like-item:hover .like-tooltip {
      visibility: visible;
      opacity: 1;
    }
    
    /* Search */
    .search-container {
      margin-bottom: 20px;
    }
    
    .search-input {
      padding: 8px;
      width: 300px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    
    /* Back button */
    .back-button {
      display: inline-block;
      padding: 8px 15px;
      background-color: #f1f1f1;
      color: #333;
      text-decoration: none;
      border-radius: 4px;
    }
    
    .back-button:hover {
      background-color: #ddd;
    }
    
    /* No clients message */
    .no-clients {
      text-align: center;
      padding: 30px;
      background-color: #f8f9fa;
      border-radius: 8px;
      margin-top: 20px;
    }
    
    /* Tables */
    .admin-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    
    .admin-table th, 
    .admin-table td {
      padding: 10px;
      text-align: right;
      border: 1px solid #ddd;
    }
    
    .admin-table th {
      background-color: #f2f2f2;
      font-weight: bold;
    }
    
    .admin-table tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    
    .admin-table tr:hover {
      background-color: #f1f1f1;
    }
    
    /* Forms */
    .admin-form {
      margin-bottom: 30px;
      padding: 20px;
      background-color: #f9f9f9;
      border-radius: 4px;
    }
    
    .form-row {
      display: flex;
      margin-bottom: 15px;
    }
    
    .form-group {
      flex: 1;
      margin-right: 15px;
    }
    
    .form-group:last-child {
      margin-right: 0;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    
    .form-group input,
    .form-group select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    
    .form-actions {
      margin-top: 15px;
    }
    
    /* Detail view */
    .client-detail {
      display: none;
      margin-top: 30px;
    }
    
    .client-detail.active {
      display: block;
    }
    
    .detail-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }
    
    .detail-title {
      font-size: 20px;
      margin: 0;
    }
    
    .detail-back {
      cursor: pointer;
      color: #3498db;
    }
    
    .product-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 20px;
    }
    
    .product-card {
      border: 1px solid #eee;
      border-radius: 8px;
      padding: 15px;
      background-color: white;
    }
    
    .product-image {
      width: 100%;
      height: 150px;
      object-fit: contain;
      margin-bottom: 10px;
    }
    
    .product-name {
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .product-barcode {
      color: #777;
      font-size: 14px;
    }
    
    /* Loading spinner */
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-top-color: #3498db;
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
    
    /* Like dashboard */
    .like-dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }
    
    .like-card {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      background-color: white;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    .like-image {
      width: 100%;
      height: 150px;
      object-fit: contain;
      margin-bottom: 10px;
    }
    
    .like-info {
      font-size: 14px;
    }
    
    .like-title {
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .like-details {
      color: #666;
      margin-bottom: 3px;
    }
    
    .like-client {
      margin-top: 10px;
      color: #3498db;
      font-weight: bold;
    }

    /* Notification Styles */
    .notification-bell {
      position: absolute;
      top: 20px;
      left: 200px;
      display: flex;
      align-items: center;
    }

    .notification-button {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      position: relative;
      padding: 5px;
    }

    .notification-count {
      position: absolute;
      top: 0;
      right: 0;
      background-color: #e74c3c;
      color: white;
      font-size: 12px;
      min-width: 18px;
      height: 18px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 4px;
      font-weight: bold;
    }

    .notification-dropdown {
      position: absolute;
      top: 40px;
      right: 0;
      width: 300px;
      max-height: 400px;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      display: none;
    }

    .notification-dropdown.show {
      display: block;
    }

    .notification-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 15px;
      border-bottom: 1px solid #eee;
    }

    .notification-header h3 {
      margin: 0;
      font-size: 16px;
    }

    .notification-header button {
      background: none;
      border: none;
      color: #3498db;
      cursor: pointer;
      font-size: 12px;
    }

    .notification-list {
      overflow-y: auto;
      max-height: 350px;
    }

    .notification-item {
      padding: 10px 15px;
      border-bottom: 1px solid #eee;
      display: flex;
      align-items: flex-start;
      cursor: pointer;
    }

    .notification-item:hover {
      background-color: #f9f9f9;
    }

    .notification-item.unread {
      background-color: #ecf0f1;
    }

    .notification-item .notification-content {
      flex: 1;
    }

    .notification-item .notification-time {
      font-size: 11px;
      color: #7f8c8d;
      margin-top: 5px;
    }

    .notification-item .notification-mark-read {
      margin-right: 10px;
      color: #3498db;
      cursor: pointer;
    }

    @media (max-width: 768px) {
      .notification-bell {
        left: 120px;
      }

      .notification-dropdown {
        width: 280px;
        right: -100px;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="logo-container">
      <img src="images/logo.png" alt="Logo" class="company-logo">
    </div>
    <h1>דאשבורד סוכן</h1>
    <div class="notification-bell">
      <button id="notification-button" class="notification-button">
        <span id="notification-icon">🔔</span>
        <span id="notification-count" class="notification-count"></span>
      </button>
      <div id="notification-dropdown" class="notification-dropdown">
        <div class="notification-header">
          <h3>התראות</h3>
          <button id="mark-all-read">סמן הכל כנקרא</button>
        </div>
        <div id="notification-list" class="notification-list">
          <!-- Notifications will be populated here -->
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="agent-container">
      <div class="agent-header">
        <h2 class="agent-title">ניהול מערכת</h2>
        <div>
          <span id="agent-user-info"></span>
          <a href="orders-agent.html" class="back-button" style="background-color: #f39c12; color: white; margin-left: 5px;">הזמנות</a>
          <a href="index.html" class="back-button">חזרה לקטלוג</a>
          <button id="agent-logout-button" class="btn btn-danger">התנתק</button>
        </div>
      </div>
      
      <div class="agent-tabs">
        <div class="agent-tab active" data-tab="clients">הלקוחות שלי</div>
        <div class="agent-tab" data-tab="likes">מועדפים</div>
      </div>
      
      <!-- Clients Tab -->
      <div class="tab-content active" id="clients-tab">
        <!-- Add Client Form -->
        <div class="admin-form">
          <h3>הוספת לקוח חדש</h3>
          <form id="add-client-form">
            <div class="form-row">
              <div class="form-group">
                <label for="client-email">אימייל</label>
                <input type="email" id="client-email" required>
              </div>
              <div class="form-group">
                <label for="client-password">סיסמה</label>
                <input type="password" id="client-password" required>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="client-name">שם</label>
                <input type="text" id="client-name" placeholder="שם מלא">
              </div>
            </div>
            <div class="form-actions">
              <button type="submit" class="btn btn-primary">הוסף לקוח</button>
            </div>
          </form>
        </div>
        
        <div class="search-container">
          <input type="text" id="client-search" class="search-input" placeholder="חיפוש לקוחות...">
        </div>
        
        <div id="clients-grid" class="clients-grid">
          <!-- Will be populated by JavaScript -->
        </div>
      </div>
      
      <!-- Likes Tab -->
      <div class="tab-content" id="likes-tab">
        <div class="admin-form">
          <h3>סינון מועדפים</h3>
          <div class="form-row">
            <div class="form-group">
              <label for="likes-client-filter">סינון לפי לקוח</label>
              <select id="likes-client-filter">
                <option value="">כל הלקוחות</option>
                <!-- Will be populated by JavaScript -->
              </select>
            </div>
          </div>
        </div>
        
        <div id="likes-dashboard" class="like-dashboard">
          <!-- Will be populated by JavaScript -->
        </div>
      </div>
      
      <!-- Client Detail View -->
      <div id="client-detail" class="client-detail">
        <div class="detail-header">
          <h3 class="detail-title">מוצרים מועדפים של <span id="detail-client-name"></span></h3>
          <span class="detail-back">&larr; חזרה לרשימת הלקוחות</span>
        </div>
        
        <div id="product-grid" class="product-grid">
          <!-- Will be populated by JavaScript -->
        </div>
      </div>
    </div>
  </main>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  
  <!-- Config -->
  <script src="firebase-config.js"></script>
  
  <!-- Agent Dashboard Logic -->
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      // Check if user is agent
      const user = auth.currentUser;
      if (!user) {
        // Wait for auth state to be determined
        auth.onAuthStateChanged(async (user) => {
          if (!user) {
            // Not logged in, redirect to login
            window.location.href = 'login.html';
            return;
          }
          
          // Check if user is agent
          const isUserAgent = await isAgent();
          if (!isUserAgent) {
            alert('אין לך הרשאות לצפות בדף זה');
            window.location.href = 'index.html';
            return;
          }
          
          // User is agent, initialize the dashboard
          initAgentDashboard(user);
        });
      } else {
        // Check if user is agent
        const isUserAgent = await isAgent();
        if (!isUserAgent) {
          alert('אין לך הרשאות לצפות בדף זה');
          window.location.href = 'index.html';
          return;
        }
        
        // User is agent, initialize the dashboard
        initAgentDashboard(user);
      }
      
      // Store current user globally for the agent dashboard
      let currentAgentUser = null;
      
      // Initialize agent dashboard
      async function initAgentDashboard(user) {
        // Store user for later use in forms
        currentAgentUser = user;
        
        // Display user info
        document.getElementById('agent-user-info').textContent = `מחובר כ: ${user.email}`;
        
        // Logout button
        document.getElementById('agent-logout-button').addEventListener('click', async () => {
          try {
            await auth.signOut();
            window.location.href = 'login.html';
          } catch (error) {
            console.error('Logout error:', error);
            alert('שגיאה בהתנתקות');
          }
        });
        
        // Tab switching
        const agentTabs = document.querySelectorAll('.agent-tab');
        const tabContents = document.querySelectorAll('.tab-content');
        
        agentTabs.forEach(tab => {
          tab.addEventListener('click', () => {
            const tabName = tab.dataset.tab;
            
            // Remove active class from all tabs and contents
            agentTabs.forEach(t => t.classList.remove('active'));
            tabContents.forEach(c => c.classList.remove('active'));
            
            // Add active class to clicked tab and corresponding content
            tab.classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // Load tab-specific data
            if (tabName === 'clients') {
              loadClients(user.uid);
            } else if (tabName === 'likes') {
              loadLikes(user.uid);
            }
          });
        });
        
        // Back button in detail view
        document.querySelector('.detail-back').addEventListener('click', () => {
          document.getElementById('client-detail').classList.remove('active');
          document.getElementById('clients-tab').classList.add('active');
        });
        
        // Add client form
        document.getElementById('add-client-form').addEventListener('submit', async (e) => {
          e.preventDefault();
          
          const email = document.getElementById('client-email').value;
          const password = document.getElementById('client-password').value;
          const name = document.getElementById('client-name').value || '';
          
          try {
            // Show loading indicator
            const submitButton = e.target.querySelector('button[type="submit"]');
            const originalButtonText = submitButton.textContent;
            submitButton.innerHTML = '<span class="spinner"></span> יוצר לקוח...';
            submitButton.disabled = true;
            
            // Get current agent info
            const agentUser = auth.currentUser;
            if (!agentUser) {
              alert('אתה לא מחובר כסוכן. אנא התחבר מחדש.');
              window.location.href = 'login.html';
              return;
            }
            const agentUid = agentUser.uid;
            
            // Create new user - we'll use the REST API to avoid affecting the current session
            let newUserUid = '';
            
            try {
              // Use the Firebase Auth REST API to create a new user without affecting the current session
              const createUserEndpoint = `https://identitytoolkit.googleapis.com/v1/accounts:signUp?key=${firebaseConfig.apiKey}`;
              const response = await fetch(createUserEndpoint, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  email: email,
                  password: password,
                  returnSecureToken: true
                })
              });
              
              const responseData = await response.json();
              
              if (response.ok) {
                newUserUid = responseData.localId;
                console.log('Created new user with UID:', newUserUid);
              } else {
                throw new Error(responseData.error?.message || 'שגיאה ביצירת לקוח');
              }
            } catch (authError) {
              console.error('Authentication error during client creation:', authError);
              alert(`שגיאה ביצירת לקוח: ${authError.message}`);
              
              // Reset button state
              submitButton.innerHTML = originalButtonText;
              submitButton.disabled = false;
              return;
            }
            
            if (!newUserUid) {
              alert('שגיאה ביצירת לקוח - לא התקבל מזהה משתמש');
              
              // Reset button state
              submitButton.innerHTML = originalButtonText;
              submitButton.disabled = false;
              return;
            }
            
            try {
              // Create all necessary Firestore documents
              // 1. First create the base user document
              console.log('Creating user document in Firestore with ID:', newUserUid);
              await db.collection('users').doc(newUserUid).set({
                email: email,
                name: name,
                role: 'client',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
              });
              console.log('User document created successfully in Firestore');
              
              // 2. Create client document with automatic assignment to current agent
              console.log('Creating client document with ID:', newUserUid);
              await db.collection('clients').doc(newUserUid).set({
                email: email,
                name: name,
                agentId: agentUid, // Automatically assign to current agent
                allowedBrands: [],
                likes: [],
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
              });
              console.log('Client document created successfully');
              
              // 3. Update the agent's clients array
              console.log('Updating agent document with ID:', agentUid);
              await db.collection('agents').doc(agentUid).update({
                clients: firebase.firestore.FieldValue.arrayUnion(newUserUid)
              });
              console.log('Agent document updated successfully');
              
              // Reset form and show success message
              document.getElementById('add-client-form').reset();
              alert(`הלקוח ${name ? name + ' (' + email + ')' : email} נוצר בהצלחה!`);
              
              // Reset button state
              submitButton.innerHTML = originalButtonText;
              submitButton.disabled = false;
              
              // Refresh clients list
              loadClients(agentUid);
            } catch (firestoreError) {
              console.error('Error creating Firestore documents:', firestoreError);
              alert(`הלקוח נוצר באימות Firebase, אך התרחשה שגיאה ביצירת המסמכים ב-Firestore: ${firestoreError.message}`);
              
              // Reset button state
              submitButton.innerHTML = originalButtonText;
              submitButton.disabled = false;
            }
          } catch (error) {
            console.error('Error in client creation process:', error);
            alert(`שגיאה ביצירת לקוח: ${error.message}`);
            
            // Reset button state if it exists
            const submitButton = e.target.querySelector('button[type="submit"]');
            if (submitButton) {
              submitButton.innerHTML = originalButtonText || 'הוסף לקוח';
              submitButton.disabled = false;
            }
          }
        });
        
        // Search input
        document.getElementById('client-search').addEventListener('input', (e) => {
          const searchTerm = e.target.value.toLowerCase();
          
          document.querySelectorAll('.client-card').forEach(card => {
            const clientEmail = card.querySelector('.client-email').textContent.toLowerCase();
            
            if (clientEmail.includes(searchTerm)) {
              card.style.display = '';
            } else {
              card.style.display = 'none';
            }
          });
        });
        
        // Client filter for likes tab
        document.getElementById('likes-client-filter').addEventListener('change', () => {
          loadLikes(user.uid);
        });
        
        // Load initial data for active tab
        const activeTab = document.querySelector('.agent-tab.active').dataset.tab;
        if (activeTab === 'clients') {
          await loadClients(user.uid);
        } else if (activeTab === 'likes') {
          await loadLikes(user.uid);
        }
      }
      
      // Load clients for agent
      async function loadClients(agentId) {
        const clientsGrid = document.getElementById('clients-grid');
        
        clientsGrid.innerHTML = '<div style="text-align: center; grid-column: 1 / -1;"><div class="spinner"></div> טוען לקוחות...</div>';
        
        try {
          // Make sure the agent has a document in the agents collection
          const agentDoc = await db.collection('agents').doc(agentId).get();
          if (!agentDoc.exists) {
            // Create agent document if it doesn't exist
            await db.collection('agents').doc(agentId).set({
              clients: [],
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
          }
          
          // Get clients for this agent
          const clientsSnapshot = await db.collection('clients')
            .where('agentId', '==', agentId)
            .get();
          
          if (clientsSnapshot.empty) {
            clientsGrid.innerHTML = '<div class="no-clients">אין לקוחות משויכים לחשבון זה</div>';
            return;
          }
          
          // Clear grid
          clientsGrid.innerHTML = '';
          
          // Load client data
          for (const doc of clientsSnapshot.docs) {
            const clientData = doc.data();
            
            // Get user info
            let userEmail = clientData.email || '';
            let userName = clientData.name || '';
            
            // If no email or name, try to get from users collection
            if (!userEmail || !userName) {
              try {
                const userDoc = await db.collection('users').doc(doc.id).get();
                if (userDoc.exists) {
                  const userData = userDoc.data();
                  if (!userEmail) userEmail = userData.email || '';
                  if (!userName) userName = userData.name || '';
                }
              } catch (userError) {
                console.error('Error getting user data:', userError);
              }
            }
            
            // Create client card
            const clientCard = document.createElement('div');
            clientCard.className = 'client-card';
            clientCard.dataset.clientId = doc.id;
            
            // Get likes info
            const likes = clientData.likes || [];
            
            clientCard.innerHTML = `
              <div class="client-header">
                <div class="client-email">${userEmail}</div>
                ${userName ? `<div class="client-name">${userName}</div>` : ''}
              </div>
              <div class="client-stats">
                <div class="stat-item">
                  <div class="stat-number">${likes.length}</div>
                  <div class="stat-label">מוצרים מועדפים</div>
                </div>
              </div>
              <button class="btn btn-primary view-likes-btn">צפה במועדפים</button>
            `;
            
            // Add client likes preview if there are any
            if (likes.length > 0) {
              const preview = document.createElement('div');
              preview.className = 'client-likes';
              
              preview.innerHTML = `
                <div class="likes-title">מועדפים אחרונים:</div>
                <div class="likes-grid">
                  ${likes.slice(0, 6).map(barcode => `
                    <div class="like-item">
                      <img src="tl/${barcode}.jpg" alt="Product" class="like-image" onerror="if(this.src.includes('tl/')){ this.src='media/${barcode}.jpg'; } else if(this.src.includes('media/')){ this.src='images/logo.png'; this.style.opacity='0.5'; }">
                      <div class="like-tooltip">${barcode}</div>
                    </div>
                  `).join('')}
                </div>
              `;
              
              clientCard.appendChild(preview);
            }
            
            clientsGrid.appendChild(clientCard);
          }
          
          // Add view likes click handlers
          document.querySelectorAll('.view-likes-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
              const clientCard = btn.closest('.client-card');
              const clientId = clientCard.dataset.clientId;
              const clientEmail = clientCard.querySelector('.client-email').textContent;
              
              await showClientLikes(clientId, clientEmail);
            });
          });
        } catch (error) {
          console.error('Error loading clients:', error);
          clientsGrid.innerHTML = '<div class="no-clients">שגיאה בטעינת לקוחות</div>';
        }
      }
      
      // Show client likes in detail view
      async function showClientLikes(clientId, clientEmail) {
        const clientDetail = document.getElementById('client-detail');
        const clientsGrid = document.getElementById('clients-grid');
        const productGrid = document.getElementById('product-grid');
        const detailClientName = document.getElementById('detail-client-name');
        
        // Show loading
        productGrid.innerHTML = '<div style="text-align: center; grid-column: 1 / -1;"><div class="spinner"></div> טוען מוצרים...</div>';
        
        // Show detail view
        clientsGrid.style.display = 'none';
        clientDetail.classList.add('active');
        detailClientName.textContent = clientEmail;
        
        try {
          // Get client data
          const clientDoc = await db.collection('clients').doc(clientId).get();
          
          if (!clientDoc.exists) {
            productGrid.innerHTML = '<div style="text-align: center; grid-column: 1 / -1;">לא נמצאו נתוני לקוח</div>';
            return;
          }
          
          const clientData = clientDoc.data();
          const likes = clientData.likes || [];
          
          if (likes.length === 0) {
            productGrid.innerHTML = '<div style="text-align: center; grid-column: 1 / -1;">אין מוצרים מועדפים ללקוח זה</div>';
            return;
          }
          
          // Clear grid
          productGrid.innerHTML = '';
          
          // Load product data
          likes.forEach(barcode => {
            // Create product card
            const productCard = document.createElement('div');
            productCard.className = 'product-card';
            
            productCard.innerHTML = `
              <img src="tl/${barcode}.jpg" alt="Product" class="product-image" onerror="if(this.src.includes('tl/')){ this.src='media/${barcode}.jpg'; } else if(this.src.includes('media/')){ this.src='images/logo.png'; this.style.opacity='0.5'; }">
              <div class="product-barcode">מק"ט: ${barcode}</div>
            `;
            
            productGrid.appendChild(productCard);
          });
        } catch (error) {
          console.error('Error loading client likes:', error);
          productGrid.innerHTML = '<div style="text-align: center; grid-column: 1 / -1;">שגיאה בטעינת מוצרים מועדפים</div>';
        }
      }
      // Load likes
      async function loadLikes(agentId) {
        const likesDashboard = document.getElementById('likes-dashboard');
        const clientFilter = document.getElementById('likes-client-filter').value;
        
        likesDashboard.innerHTML = '<div style="text-align: center; grid-column: 1 / -1;">טוען מועדפים...</div>';
        
        try {
          // Populate client filter if not already populated
          const clientSelect = document.getElementById('likes-client-filter');
          if (clientSelect.options.length <= 1) {
            // Get clients for this agent
            const clientsSnapshot = await db.collection('clients')
              .where('agentId', '==', agentId)
              .get();
              
            if (!clientsSnapshot.empty) {
              clientsSnapshot.forEach(async doc => {
                const clientData = doc.data();
                let userEmail = clientData.email || '';
                
                // If no email, try to get from users collection
                if (!userEmail) {
                  try {
                    const userDoc = await db.collection('users').doc(doc.id).get();
                    if (userDoc.exists) {
                      userEmail = userDoc.data().email || '';
                    }
                  } catch (userError) {
                    console.error('Error getting user data:', userError);
                  }
                }
                
                if (userEmail) {
                  const option = document.createElement('option');
                  option.value = doc.id;
                  option.textContent = userEmail;
                  clientSelect.appendChild(option);
                }
              });
            }
          }
          
          // Build query based on filters
          let clientsQuery = db.collection('clients');
          
          if (clientFilter) {
            // Specific client filter
            clientsQuery = db.collection('clients').where(firebase.firestore.FieldPath.documentId(), '==', clientFilter);
          } else {
            // All clients for this agent
            clientsQuery = db.collection('clients').where('agentId', '==', agentId);
          }
          
          const clientsSnapshot = await clientsQuery.get();
          
          if (clientsSnapshot.empty) {
            likesDashboard.innerHTML = '<div style="text-align: center; grid-column: 1 / -1;">לא נמצאו לקוחות</div>';
            return;
          }
          
          // Get all liked products
          const allLikes = [];
          const clientsMap = {};
          
          for (const doc of clientsSnapshot.docs) {
            const clientData = doc.data();
            const likes = clientData.likes || [];
            
            // Get user email if needed
            let userEmail = clientData.email || '';
            if (!userEmail) {
              try {
                const userDoc = await db.collection('users').doc(doc.id).get();
                if (userDoc.exists) {
                  userEmail = userDoc.data().email || '';
                }
              } catch (userError) {
                console.error('Error getting user data:', userError);
              }
            }
            
            clientsMap[doc.id] = userEmail || 'Unknown';
            
            likes.forEach(barcode => {
              allLikes.push({
                barcode,
                clientId: doc.id,
                clientEmail: userEmail || 'Unknown'
              });
            });
          }
          
          if (allLikes.length === 0) {
            likesDashboard.innerHTML = '<div style="text-align: center; grid-column: 1 / -1;">לא נמצאו מוצרים מועדפים</div>';
            return;
          }
          
          // Clear dashboard
          likesDashboard.innerHTML = '';
          
          // Group likes by barcode
          const groupedLikes = {};
          
          allLikes.forEach(like => {
            if (!groupedLikes[like.barcode]) {
              groupedLikes[like.barcode] = {
                barcode: like.barcode,
                clients: []
              };
            }
            
            groupedLikes[like.barcode].clients.push({
              id: like.clientId,
              email: like.clientEmail
            });
          });
          
          // Create product cards
          Object.values(groupedLikes).forEach(product => {
            const card = document.createElement('div');
            card.className = 'like-card';
            
            card.innerHTML = `
              <img src="tl/${product.barcode}.jpg" alt="Product" class="like-image" onerror="if(this.src.includes('tl/')){ this.src='media/${product.barcode}.jpg'; } else if(this.src.includes('media/')){ this.src='images/logo.png'; this.style.opacity='0.5'; }">
              <div class="like-info">
                <div class="like-title">מק"ט: ${product.barcode}</div>
                <div class="like-details">מספר לקוחות: ${product.clients.length}</div>
                <div class="like-client">${product.clients.map(c => c.email).join(', ')}</div>
              </div>
            `;
            
            likesDashboard.appendChild(card);
          });
        } catch (error) {
          console.error('Error loading likes:', error);
          likesDashboard.innerHTML = `<div style="text-align: center; grid-column: 1 / -1; color: red;">שגיאה בטעינת מועדפים: ${error.message}</div>`;
        }
      }
    });
  </script>

  <!-- Notification System Script -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Get DOM elements
      const notificationButton = document.getElementById('notification-button');
      const notificationCount = document.getElementById('notification-count');
      const notificationDropdown = document.getElementById('notification-dropdown');
      const notificationList = document.getElementById('notification-list');
      const markAllReadButton = document.getElementById('mark-all-read');

      // Notification data
      let notifications = [];
      let unreadCount = 0;

      // Toggle notification dropdown
      notificationButton.addEventListener('click', () => {
        notificationDropdown.classList.toggle('show');
      });

      // Close dropdown when clicking outside
      document.addEventListener('click', (event) => {
        if (!notificationButton.contains(event.target) && !notificationDropdown.contains(event.target)) {
          notificationDropdown.classList.remove('show');
        }
      });

      // Mark all notifications as read
      markAllReadButton.addEventListener('click', async () => {
        try {
          const user = auth.currentUser;
          if (!user) return;

          const batch = db.batch();

          // Get all unread notifications
          const unreadNotifications = await db.collection('notifications')
            .where('recipientId', '==', user.uid)
            .where('read', '==', false)
            .get();

          // Mark all as read in a batch
          unreadNotifications.forEach(doc => {
            batch.update(doc.ref, { read: true });
          });

          await batch.commit();

          // Update UI
          document.querySelectorAll('.notification-item.unread').forEach(item => {
            item.classList.remove('unread');
          });

          unreadCount = 0;
          updateNotificationCount();

        } catch (error) {
          console.error('Error marking all as read:', error);
        }
      });

      // Update notification count badge
      function updateNotificationCount() {
        if (unreadCount > 0) {
          notificationCount.textContent = unreadCount;
          notificationCount.style.display = 'flex';
        } else {
          notificationCount.style.display = 'none';
        }
      }

      // Format timestamp to relative time
      function formatTimeAgo(timestamp) {
        if (!timestamp) return '';

        const now = new Date();
        const date = timestamp.toDate();
        const diffMs = now - date;
        const diffSec = Math.floor(diffMs / 1000);
        const diffMin = Math.floor(diffSec / 60);
        const diffHour = Math.floor(diffMin / 60);
        const diffDay = Math.floor(diffHour / 24);

        if (diffSec < 60) {
          return 'כרגע';
        } else if (diffMin < 60) {
          return `לפני ${diffMin} דק'`;
        } else if (diffHour < 24) {
          return `לפני ${diffHour} שעות`;
        } else if (diffDay < 7) {
          return `לפני ${diffDay} ימים`;
        } else {
          return date.toLocaleDateString('he-IL');
        }
      }

      // Create notification item element
      function createNotificationItem(notification) {
        const item = document.createElement('div');
        item.className = `notification-item ${notification.read ? '' : 'unread'}`;
        item.dataset.id = notification.id;

        item.innerHTML = `
          <div class="notification-content">
            <div>${notification.message}</div>
            <div class="notification-time">${formatTimeAgo(notification.createdAt)}</div>
          </div>
        `;

        // Add click event for notification
        item.addEventListener('click', async () => {
          // Mark as read if unread
          if (!notification.read) {
            try {
              await db.collection('notifications').doc(notification.id).update({
                read: true
              });

              // Update UI
              item.classList.remove('unread');
              unreadCount--;
              updateNotificationCount();

            } catch (error) {
              console.error('Error marking notification as read:', error);
            }
          }

          // If it's an order notification, navigate to the orders page
          if (notification.type === 'new_order' && notification.orderId) {
            window.location.href = 'orders-agent.html';
          }
        });

        return item;
      }

      // Load notifications from Firestore
      async function loadNotifications() {
        try {
          const user = auth.currentUser;
          if (!user) {
            console.log('No user logged in');
            return;
          }

          console.log('Loading notifications for user:', user.uid);

          // Clear previous notifications
          notificationList.innerHTML = '<div style="text-align: center; padding: 10px;">טוען התראות...</div>';

          // Get notifications for this user
          console.log('Executing query for notifications where recipientId =', user.uid);
          const notificationsSnapshot = await db.collection('notifications')
            .where('recipientId', '==', user.uid)
            .orderBy('createdAt', 'desc')
            .limit(20)
            .get();

          console.log(`Query returned ${notificationsSnapshot.size} notifications`);

          if (notificationsSnapshot.empty) {
            console.log('No notifications found');
            notificationList.innerHTML = '<div class="notification-empty">אין התראות</div>';
            unreadCount = 0;
          } else {
            notifications = [];
            unreadCount = 0;
            notificationList.innerHTML = ''; // Clear loading message

            notificationsSnapshot.forEach(doc => {
              console.log('Processing notification:', doc.id);
              const notificationData = doc.data();
              console.log('Notification data:', notificationData);
              
              const notification = {
                id: doc.id,
                ...notificationData
              };

              notifications.push(notification);

              // Count unread notifications
              if (!notification.read) {
                unreadCount++;
              }

              // Create and append notification item
              const notificationItem = createNotificationItem(notification);
              notificationList.appendChild(notificationItem);
            });
            
            console.log(`Processed ${notifications.length} notifications, ${unreadCount} unread`);
          }

          // Update notification count
          updateNotificationCount();

        } catch (error) {
          console.error('Error loading notifications:', error);
          console.error('Error details:', error.code, error.message, error.details);
          notificationList.innerHTML = `<div class="notification-error">שגיאה בטעינת התראות: ${error.message}</div>`;
          
          // Check if this is an indexing error
          if (error.code === 'failed-precondition' || error.message.includes('index')) {
            notificationList.innerHTML += `<div style="margin-top: 10px">
              <p>נדרש אינדקס בפיירסטור. אנא צור את האינדקס הבא:</p>
              <p>Collection: notifications</p>
              <p>Fields: recipientId (ascending), createdAt (descending)</p>
              <a href="https://console.firebase.google.com/project/agatd-e37c7/firestore/indexes" target="_blank">פתח הגדרות אינדקסים בפיירסטור</a>
            </div>`;
          }
        }
      }

      // Listen for auth state changes
      auth.onAuthStateChanged(user => {
        if (user) {
          // Load notifications
          loadNotifications();

          // Set up real-time listener for new notifications
          const unsubscribe = db.collection('notifications')
            .where('recipientId', '==', user.uid)
            .where('read', '==', false)
            .onSnapshot(snapshot => {
              // Check for added notifications
              const changes = snapshot.docChanges();

              let newNotifications = false;

              changes.forEach(change => {
                if (change.type === 'added') {
                  newNotifications = true;
                  unreadCount++;

                  // Get the notification data
                  const notification = {
                    id: change.doc.id,
                    ...change.doc.data()
                  };

                  // Add to the beginning of the list
                  const notificationItem = createNotificationItem(notification);
                  notificationList.insertBefore(notificationItem, notificationList.firstChild);

                  // Remove empty notification message if present
                  const emptyMessage = notificationList.querySelector('.notification-empty');
                  if (emptyMessage) {
                    notificationList.removeChild(emptyMessage);
                  }
                }
              });

              if (newNotifications) {
                // Play notification sound
                // const notificationSound = new Audio('path/to/notification-sound.mp3');
                // notificationSound.play();

                // Update notification count
                updateNotificationCount();
              }
            });

          // Store the unsubscribe function
          window.notificationsUnsubscribe = unsubscribe;
        } else {
          // User is logged out, unsubscribe from notifications
          if (window.notificationsUnsubscribe) {
            window.notificationsUnsubscribe();
          }
        }
      });
    });
  </script>
</body>
</html>