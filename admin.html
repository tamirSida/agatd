<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>  - AGAT&D</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="icon" href="images/logo.png" type="image/png">
  <style>
    /* Admin panel styles */
    .admin-container {
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    
    .admin-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #eee;
    }
    
    .admin-title {
      margin: 0;
      font-size: 24px;
      color: #333;
    }
    
    .admin-tabs {
      display: flex;
      border-bottom: 1px solid #ddd;
      margin-bottom: 20px;
    }
    
    .admin-tab {
      padding: 10px 20px;
      cursor: pointer;
      background-color: #f9f9f9;
      border: 1px solid #ddd;
      border-bottom: none;
      border-radius: 4px 4px 0 0;
      margin-right: 5px;
    }
    
    .admin-tab.active {
      background-color: #fff;
      border-bottom: 1px solid #fff;
      margin-bottom: -1px;
      font-weight: bold;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    /* Tables */
    .admin-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    
    .admin-table th, 
    .admin-table td {
      padding: 10px;
      text-align: right;
      border: 1px solid #ddd;
    }
    
    .admin-table th {
      background-color: #f2f2f2;
      font-weight: bold;
    }
    
    .admin-table tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    
    .admin-table tr:hover {
      background-color: #f1f1f1;
    }
    
    /* Forms */
    .admin-form {
      margin-bottom: 30px;
      padding: 20px;
      background-color: #f9f9f9;
      border-radius: 4px;
    }
    
    .form-row {
      display: flex;
      margin-bottom: 15px;
      width: 100%;
      flex-wrap: wrap;
    }
    
    .form-group {
      flex: 1;
      margin-right: 15px;
    }
    
    .form-group:last-child {
      margin-right: 0;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    
    .form-group input,
    .form-group select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      max-width: 100%;
      text-overflow: ellipsis;
    }
    
    /* Ensure dropdowns have proper width and text handling */
    select {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      width: 100%;
      min-width: 200px;
      max-width: 100%;
      direction: rtl;
      text-align: right;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      background-image: url("data:image/svg+xml;utf8,<svg fill='black' height='24' viewBox='0 0 24 24' width='24' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/><path d='M0 0h24v24H0z' fill='none'/></svg>");
      background-repeat: no-repeat;
      background-position: left 5px center;
      background-size: 16px;
      padding-left: 25px;
    }
    
    /* Fix for agent assignment row specific alignment */
    #agent-assignment-row .form-group {
      width: 100%;
    }
    
    #user-agent {
      width: 100%;
    }
    
    .form-actions {
      margin-top: 15px;
    }
    
    .btn {
      padding: 8px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .btn-primary {
      background-color: #3498db;
      color: white;
    }
    
    .btn-success {
      background-color: #2ecc71;
      color: white;
    }
    
    .btn-danger {
      background-color: #e74c3c;
      color: white;
    }
    
    .btn-warning {
      background-color: #f39c12;
      color: white;
    }
    
    /* Status Badges */
    .badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 3px;
      font-size: 12px;
      font-weight: bold;
    }
    
    .badge-success {
      background-color: #dff2e1;
      color: #27ae60;
    }
    
    .badge-danger {
      background-color: #f8d7da;
      color: #e74c3c;
    }
    
    .badge-warning {
      background-color: #ffeeba;
      color: #f39c12;
    }
    
    .badge-info {
      background-color: #d1ecf1;
      color: #17a2b8;
    }
    
    /* Multi-select */
    .multiselect-container {
      position: relative;
      width: 100%;
    }
    
    .multiselect-checkbox-list {
      width: 100%;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background-color: white;
      max-height: 300px;
      overflow-y: auto;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }
    
    .multiselect-option {
      display: flex;
      align-items: center;
      padding: 5px;
      border-radius: 4px;
      transition: background-color 0.2s;
    }
    
    .multiselect-option:hover {
      background-color: #f4f8fb;
    }
    
    .multiselect-option label {
      cursor: pointer;
      margin: 0;
      padding-right: 8px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-size: 14px;
    }
    
    .multiselect-checkbox {
      margin-left: 10px;
      width: 16px;
      height: 16px;
      cursor: pointer;
    }
    
    .multiselect-select-all {
      grid-column: 1 / -1;
      margin-bottom: 10px;
      padding: 8px;
      text-align: center;
      background-color: #f9f9f9;
      border-radius: 4px;
      font-weight: bold;
    }
    
    .multiselect-actions {
      grid-column: 1 / -1;
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
      border-top: 1px solid #eee;
      padding-top: 10px;
    }
    
    .multiselect-filter {
      margin-bottom: 10px;
      grid-column: 1 / -1;
    }
    
    .multiselect-filter input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    
    /* Search */
    .search-container {
      margin-bottom: 20px;
    }
    
    .search-input {
      padding: 8px;
      width: 300px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    
    /* Loading spinner */
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-top-color: #3498db;
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
    
    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
    }
    
    .modal-content {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      max-width: 500px;
      width: 100%;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }
    
    .modal-title {
      margin: 0;
      font-size: 20px;
    }
    
    .modal-close {
      cursor: pointer;
      font-size: 24px;
      background: none;
      border: none;
    }
    
    .modal-body {
      margin-bottom: 20px;
    }
    
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    
    /* Back to catalog button */
    .back-button {
      display: inline-block;
      padding: 8px 15px;
      background-color: #f1f1f1;
      color: #333;
      text-decoration: none;
      border-radius: 4px;
    }
    
    .back-button:hover {
      background-color: #ddd;
    }
    
    /* Like dashboard */
    .like-dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }
    
    .like-card {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      background-color: white;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    .like-image {
      width: 100%;
      height: 150px;
      object-fit: contain;
      margin-bottom: 10px;
    }
    
    .like-info {
      font-size: 14px;
    }
    
    .like-title {
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .like-details {
      color: #666;
      margin-bottom: 3px;
    }
    
    .like-client {
      margin-top: 10px;
      color: #3498db;
      font-weight: bold;
    }

    /* Notification Styles */
    .notification-bell {
      position: absolute;
      top: 20px;
      left: 200px;
      display: flex;
      align-items: center;
    }

    .notification-button {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      position: relative;
      padding: 5px;
    }

    .notification-count {
      position: absolute;
      top: 0;
      right: 0;
      background-color: #e74c3c;
      color: white;
      font-size: 12px;
      min-width: 18px;
      height: 18px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 4px;
      font-weight: bold;
    }

    .notification-dropdown {
      position: absolute;
      top: 40px;
      right: 0;
      width: 300px;
      max-height: 400px;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      display: none;
    }

    .notification-dropdown.show {
      display: block;
    }

    .notification-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 15px;
      border-bottom: 1px solid #eee;
    }

    .notification-header h3 {
      margin: 0;
      font-size: 16px;
    }

    .notification-header button {
      background: none;
      border: none;
      color: #3498db;
      cursor: pointer;
      font-size: 12px;
    }

    .notification-list {
      overflow-y: auto;
      max-height: 350px;
    }

    .notification-item {
      padding: 10px 15px;
      border-bottom: 1px solid #eee;
      display: flex;
      align-items: flex-start;
      cursor: pointer;
    }

    .notification-item:hover {
      background-color: #f9f9f9;
    }

    .notification-item.unread {
      background-color: #ecf0f1;
    }

    .notification-item .notification-content {
      flex: 1;
    }

    .notification-item .notification-time {
      font-size: 11px;
      color: #7f8c8d;
      margin-top: 5px;
    }

    .notification-item .notification-mark-read {
      margin-right: 10px;
      color: #3498db;
      cursor: pointer;
    }

    @media (max-width: 768px) {
      .notification-bell {
        left: 120px;
      }

      .notification-dropdown {
        width: 280px;
        right: -100px;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="logo-container">
      <img src="images/logo.png" alt="Logo" class="company-logo">
    </div>
    <h1> </h1>
    <div class="notification-bell">
      <button id="notification-button" class="notification-button">
        <span id="notification-icon"></span>
        <span id="notification-count" class="notification-count"></span>
      </button>
      <div id="notification-dropdown" class="notification-dropdown">
        <div class="notification-header">
          <h3>转专转</h3>
          <button id="mark-all-read">住  拽专</button>
        </div>
        <div id="notification-list" class="notification-list">
          <!-- Notifications will be populated here -->
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="admin-container">
      <div class="admin-header">
        <h2 class="admin-title"> 注专转</h2>
        <div>
          <span id="admin-user-info"></span>
          <a href="orders-admin.html" class="back-button" style="background-color: #27ae60; color: white; margin-left: 5px;">转</a>
          <a href="index.html" class="back-button">专 拽</a>
          <button id="admin-logout-button" class="btn btn-danger">转转拽</button>
        </div>
      </div>
      
      <div class="admin-tabs">
        <div class="admin-tab active" data-tab="users">砖转砖</div>
        <div class="admin-tab" data-tab="clients">拽转</div>
        <div class="admin-tab" data-tab="agents">住</div>
        <div class="admin-tab" data-tab="registration">拽砖转 专砖</div>
        <div class="admin-tab" data-tab="likes">注驻</div>
      </div>
      
      <!-- Users Tab -->
      <div class="tab-content active" id="users-tab">
        <div class="admin-form">
          <h3>住驻转 砖转砖 砖</h3>
          <form id="add-user-form">
            <div class="form-row">
              <div class="form-group">
                <label for="user-email"></label>
                <input type="email" id="user-email" required>
              </div>
              <div class="form-group">
                <label for="user-password">住住</label>
                <input type="password" id="user-password" required>
              </div>
              <div class="form-group">
                <label for="user-role">转驻拽</label>
                <select id="user-role" required>
                  <option value="client">拽</option>
                  <option value="agent">住</option>
                  <option value="admin"></option>
                </select>
              </div>
            </div>
            <!-- Agent Selection - Match first form row style -->
            <div class="form-row" id="agent-assignment-row" style="display: none; margin-top: 15px;">
              <div class="form-group" style="width: 33.333%; margin-right: 15px;">
                <label for="user-agent" style="display: block; margin-bottom: 5px; font-weight: bold;">住 驻</label>
                <select id="user-agent" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; direction: rtl; text-align: right;">
                  <option value="">--  住 --</option>
                  <!-- Will be populated by JavaScript -->
                </select>
              </div>
              <!-- Add empty div to match layout -->
              <div style="flex: 2;"></div>
            </div>
            <div class="form-actions">
              <button type="submit" class="btn btn-primary">住祝 砖转砖</button>
            </div>
          </form>
        </div>
        
        <div class="search-container">
          <input type="text" id="users-search" class="search-input" placeholder="驻砖 砖转砖...">
        </div>
        
        <table class="admin-table" id="users-table">
          <thead>
            <tr>
              <th></th>
              <th>转驻拽</th>
              <th>转专 爪专驻转</th>
              <th>驻注转</th>
            </tr>
          </thead>
          <tbody id="users-table-body">
            <!-- Will be populated by JavaScript -->
          </tbody>
        </table>
      </div>
      
      <!-- Clients Tab -->
      <div class="tab-content" id="clients-tab">
        <div class="admin-form">
          <h3> 拽转</h3>
          <form id="update-client-form">
            <div class="form-row">
              <div class="form-group">
                <label for="client-select">专 拽</label>
                <select id="client-select" required>
                  <option value="">-- 专 拽 --</option>
                  <!-- Will be populated by JavaScript -->
                </select>
              </div>
              <div class="form-group">
                <label for="client-agent">住</label>
                <select id="client-agent">
                  <option value="">--  住 --</option>
                  <!-- Will be populated by JavaScript -->
                </select>
              </div>
            </div>
            <div class="form-actions">
              <button type="submit" class="btn btn-primary">注 拽</button>
            </div>
          </form>
        </div>
        
        <div class="search-container">
          <input type="text" id="clients-search" class="search-input" placeholder="驻砖 拽转...">
        </div>
        
        <table class="admin-table" id="clients-table">
          <thead>
            <tr>
              <th></th>
              <th>住</th>
              <th>转专 爪专驻转</th>
              <th>住驻专 注驻</th>
              <th>驻注转</th>
            </tr>
          </thead>
          <tbody id="clients-table-body">
            <!-- Will be populated by JavaScript -->
          </tbody>
        </table>
      </div>
      
      <!-- Agents Tab -->
      <div class="tab-content" id="agents-tab">
        <div class="search-container">
          <input type="text" id="agents-search" class="search-input" placeholder="驻砖 住...">
        </div>
        
        <table class="admin-table" id="agents-table">
          <thead>
            <tr>
              <th></th>
              <th>住驻专 拽转</th>
              <th>转专 爪专驻转</th>
              <th>驻注转</th>
            </tr>
          </thead>
          <tbody id="agents-table-body">
            <!-- Will be populated by JavaScript -->
          </tbody>
        </table>
      </div>
      
      <!-- Registration Requests Tab -->
      <div class="tab-content" id="registration-tab">
        <table class="admin-table" id="registration-table">
          <thead>
            <tr>
              <th>砖</th>
              <th></th>
              <th>转驻拽 拽砖</th>
              <th>住住</th>
              <th>转专 拽砖</th>
              <th>驻注转</th>
            </tr>
          </thead>
          <tbody id="registration-table-body">
            <!-- Will be populated by JavaScript -->
          </tbody>
        </table>
      </div>
      
      <!-- Likes Tab -->
      <div class="tab-content" id="likes-tab">
        <div class="admin-form">
          <h3>住 注驻</h3>
          <div class="form-row">
            <div class="form-group">
              <label for="likes-client-filter">住 驻 拽</label>
              <select id="likes-client-filter">
                <option value=""> 拽转</option>
                <!-- Will be populated by JavaScript -->
              </select>
            </div>
            <div class="form-group">
              <label for="likes-agent-filter">住 驻 住</label>
              <select id="likes-agent-filter">
                <option value=""> 住</option>
                <!-- Will be populated by JavaScript -->
              </select>
            </div>
          </div>
        </div>
        
        <div id="likes-dashboard" class="like-dashboard">
          <!-- Will be populated by JavaScript -->
        </div>
      </div>
    </div>
    
    <!-- Edit User Modal -->
    <div id="edit-user-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">注专 砖转砖</h3>
          <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
          <form id="edit-user-form">
            <input type="hidden" id="edit-user-id">
            <div class="form-group">
              <label for="edit-user-email"></label>
              <input type="email" id="edit-user-email" readonly>
            </div>
            <div class="form-group">
              <label for="edit-user-role">转驻拽</label>
              <select id="edit-user-role" required>
                <option value="client">拽</option>
                <option value="agent">住</option>
                <option value="admin"></option>
              </select>
            </div>
            <div class="form-group">
              <label for="edit-user-password">住住 砖 (砖专 专拽   砖)</label>
              <input type="password" id="edit-user-password">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button id="edit-user-save" class="btn btn-primary">砖专 砖</button>
          <button id="edit-user-delete" class="btn btn-danger">拽 砖转砖</button>
          <button class="modal-close-btn btn"></button>
        </div>
      </div>
    </div>
  </main>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  
  <!-- Config -->
  <script src="firebase-config.js"></script>
  
  <!-- Admin Panel Logic -->
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      // Check if user is admin
      const user = auth.currentUser;
      if (!user) {
        // Wait for auth state to be determined
        auth.onAuthStateChanged(async (user) => {
          if (!user) {
            // Not logged in, redirect to login
            window.location.href = 'login.html';
            return;
          }
          
          // Check if user is admin
          const isUserAdmin = await isAdmin();
          if (!isUserAdmin) {
            alert('  专砖转 爪驻转 祝 ');
            window.location.href = 'index.html';
            return;
          }
          
          // User is admin, initialize the panel
          initAdminPanel(user);
        });
      } else {
        // Check if user is admin
        const isUserAdmin = await isAdmin();
        if (!isUserAdmin) {
          alert('  专砖转 爪驻转 祝 ');
          window.location.href = 'index.html';
          return;
        }
        
        // User is admin, initialize the panel
        initAdminPanel(user);
      }
      
      // Initialize admin panel
      async function initAdminPanel(user) {
        // Display user info
        document.getElementById('admin-user-info').textContent = `专 : ${user.email}`;
        
        // Logout button
        document.getElementById('admin-logout-button').addEventListener('click', async () => {
          try {
            await auth.signOut();
            window.location.href = 'login.html';
          } catch (error) {
            console.error('Logout error:', error);
            alert('砖 转转拽转');
          }
        });
        
        // Tab switching
        const adminTabs = document.querySelectorAll('.admin-tab');
        const tabContents = document.querySelectorAll('.tab-content');
        
        adminTabs.forEach(tab => {
          tab.addEventListener('click', () => {
            const tabName = tab.dataset.tab;
            
            // Remove active class from all tabs and contents
            adminTabs.forEach(t => t.classList.remove('active'));
            tabContents.forEach(c => c.classList.remove('active'));
            
            // Add active class to clicked tab and corresponding content
            tab.classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // Load tab-specific data
            if (tabName === 'users') {
              loadUsers();
            } else if (tabName === 'clients') {
              loadClients();
              loadAgentsForSelect();
              loadBrandsForMultiselect();
            } else if (tabName === 'agents') {
              loadAgents();
            } else if (tabName === 'registration') {
              loadRegistrationRequests();
            } else if (tabName === 'likes') {
              loadLikes();
            }
          });
        });
        
        // Modal close buttons
        document.querySelectorAll('.modal-close, .modal-close-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            document.querySelectorAll('.modal').forEach(modal => {
              modal.style.display = 'none';
            });
          });
        });
        
        // Click outside modal to close
        window.addEventListener('click', (event) => {
          document.querySelectorAll('.modal').forEach(modal => {
            if (event.target === modal) {
              modal.style.display = 'none';
            }
          });
        });
        
        // Initialize multiselect dropdown - only if these elements exist
        const brandsInput = document.getElementById('brands-input');
        const brandsDropdown = document.getElementById('brands-dropdown');
        
        if (brandsInput && brandsDropdown) {
          brandsInput.addEventListener('click', () => {
            brandsDropdown.style.display = brandsDropdown.style.display === 'block' ? 'none' : 'block';
          });
          
          // Close dropdown when clicking outside
          document.addEventListener('click', (event) => {
            if (!event.target.closest('.multiselect-container')) {
              brandsDropdown.style.display = 'none';
            }
          });
        }
        
        // Set up role select to show/hide agent selection
        const roleSelect = document.getElementById('user-role');
        const agentAssignmentRow = document.getElementById('agent-assignment-row');
        
        // Load agents only once at initialization
        let agentsLoaded = false;
        
        roleSelect.addEventListener('change', function() {
          if (this.value === 'client') {
            agentAssignmentRow.style.display = '';
            // Load agents into the dropdown if not already loaded
            if (!agentsLoaded) {
              loadAgentsForUserForm();
              agentsLoaded = true;
            }
          } else {
            agentAssignmentRow.style.display = 'none';
          }
        });
        
        // Show agent selection row initially if client role is selected by default
        if (roleSelect.value === 'client') {
          agentAssignmentRow.style.display = '';
        }
        
        // Load initial data for active tab
        const activeTab = document.querySelector('.admin-tab.active').dataset.tab;
        if (activeTab === 'users') {
          loadUsers();
          // Pre-load agents for the form once
          loadAgentsForUserForm();
          agentsLoaded = true;
        } else if (activeTab === 'clients') {
          loadClients();
          loadAgentsForSelect();
          loadBrandsForMultiselect();
        } else if (activeTab === 'agents') {
          loadAgents();
        } else if (activeTab === 'registration') {
          loadRegistrationRequests();
        } else if (activeTab === 'likes') {
          loadLikes();
        }
        
        // Add user form
        document.getElementById('add-user-form').addEventListener('submit', async (e) => {
          e.preventDefault();
          
          const email = document.getElementById('user-email').value;
          const password = document.getElementById('user-password').value;
          const role = document.getElementById('user-role').value;
          
          try {
            // Validate that clients have an agent assigned
            if (role === USER_ROLES.CLIENT) {
              const selectedAgentId = document.getElementById('user-agent').value;
              if (!selectedAgentId) {
                alert(' 专 住 注专 拽 砖');
                return;
              }
            }
            
            // Show loading indicator
            const submitButton = e.target.querySelector('button[type="submit"]');
            const originalButtonText = submitButton.textContent;
            submitButton.innerHTML = '<span class="spinner"></span> 爪专 砖转砖...';
            submitButton.disabled = true;
            
            // Create new user - we'll create the user using the Admin SDK
            let newUserCredential = null;
            let newUserUid = '';
            
            try {
              // Create new user using Firebase Auth REST API
              // Store the current user for re-authentication
              const adminUser = auth.currentUser;
              
              if (!adminUser) {
                alert('转  专 .  转专 砖.');
                window.location.href = 'login.html';
                return;
              }
              
              // Get a fresh ID token for the admin
              const adminIdToken = await adminUser.getIdToken(true);
              
              // Use the Firebase Auth REST API to create a new user without affecting the current session
              const createUserEndpoint = `https://identitytoolkit.googleapis.com/v1/accounts:signUp?key=${firebaseConfig.apiKey}`;
              const response = await fetch(createUserEndpoint, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  email: email,
                  password: password,
                  returnSecureToken: true
                })
              });
              
              const responseData = await response.json();
              
              if (response.ok) {
                newUserUid = responseData.localId;
                console.log('Created new user with UID:', newUserUid);
              } else {
                throw new Error(responseData.error?.message || '砖 爪专转 砖转砖');
              }
            } catch (authError) {
              console.error('Authentication error during user creation:', authError);
              alert(`砖 爪专转 砖转砖: ${authError.message}`);
              
              // Reset button state
              submitButton.innerHTML = originalButtonText;
              submitButton.disabled = false;
              return;
            }
            
            if (!newUserUid) {
              alert('砖 爪专转 砖转砖 -  转拽  砖转砖');
              
              // Reset button state
              submitButton.innerHTML = originalButtonText;
              submitButton.disabled = false;
              return;
            }
            
            try {
              // Create all necessary Firestore documents based on user role
              // 1. First create the base user document
              console.log('Creating user document in Firestore with ID:', newUserUid);
              await db.collection('users').doc(newUserUid).set({
                email: email,
                role: role,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
              });
              console.log('User document created successfully in Firestore');
              
              // 2. Create additional documents based on role
              if (role === USER_ROLES.CLIENT) {
                // Client role - must have an agent
                const selectedAgentId = document.getElementById('user-agent').value;
                
                // Create client document with agent
                const clientData = {
                  email: email,
                  allowedBrands: [],
                  likes: [],
                  agentId: selectedAgentId,
                  createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // Create client document first
                console.log('Creating client document with ID:', newUserUid);
                await db.collection('clients').doc(newUserUid).set(clientData);
                console.log('Client document created successfully');
                
                // Then update agent's client list
                console.log('Updating agent document with ID:', selectedAgentId);
                await db.collection('agents').doc(selectedAgentId).update({
                  clients: firebase.firestore.FieldValue.arrayUnion(newUserUid)
                });
                console.log('Agent document updated successfully');
              } else if (role === USER_ROLES.AGENT) {
                // Agent role - create agent document
                console.log('Creating agent document with ID:', newUserUid);
                await db.collection('agents').doc(newUserUid).set({
                  email: email,
                  clients: [],
                  createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                console.log('Agent document created successfully');
                
                // We no longer create client records for agents to keep the collections properly separated
              } else if (role === USER_ROLES.ADMIN) {
                // Admin role - no need to create client record
                console.log('Admin user created successfully - skipping client document creation');
                // We don't create a client document for admin users as they shouldn't appear in the clients list
              }
              
              // Reset form and show success message
              document.getElementById('add-user-form').reset();
              alert(`砖转砖 ${email} 爪专 爪!`);
              
              // Reset button state
              submitButton.innerHTML = originalButtonText;
              submitButton.disabled = false;
              
              // Refresh user list
              loadUsers();
            } catch (firestoreError) {
              console.error('Error creating Firestore documents:', firestoreError);
              alert(`砖转砖 爪专 转 Firebase,  转专砖 砖 爪专转 住 -Firestore: ${firestoreError.message}`);
              
              // Reset button state
              submitButton.innerHTML = originalButtonText;
              submitButton.disabled = false;
            }
          } catch (error) {
            console.error('Error in user creation process:', error);
            alert(`砖 爪专转 砖转砖: ${error.message}`);
            
            // Reset button state if it exists
            const submitButton = e.target.querySelector('button[type="submit"]');
            if (submitButton) {
              submitButton.innerHTML = originalButtonText || '住祝 砖转砖';
              submitButton.disabled = false;
            }
          }
        });
        
        // Edit user form save
        document.getElementById('edit-user-save').addEventListener('click', async () => {
          const userId = document.getElementById('edit-user-id').value;
          const newRole = document.getElementById('edit-user-role').value;
          const newPassword = document.getElementById('edit-user-password').value;
          
          try {
            // Update user role
            await db.collection('users').doc(userId).update({
              role: newRole
            });
            
            // Update password if provided
            if (newPassword) {
              try {
                const user = firebase.auth().currentUser;
                if (user.uid === userId) {
                  // Cannot change own password from admin panel
                  alert('  砖转 转 住住 砖 注爪 转 驻 , 砖转砖 驻砖专转 驻住 住住 注 转专转');
                } else {
                  // Only admins have access to the Firebase Admin SDK for password resets
                  // For frontend access, generate reset link instead
                  const userRecord = await db.collection('users').doc(userId).get();
                  await firebase.auth().sendPasswordResetEmail(userRecord.data().email);
                  alert('砖 拽砖专 驻住 住住');
                }
              } catch (passwordError) {
                console.error('Error resetting password:', passwordError);
                alert(`砖 驻住 住住: ${passwordError.message}`);
              }
            }
            
            // Check for role changes
            const userDoc = await db.collection('users').doc(userId).get();
            const oldRole = userDoc.data().role;
            
            if (oldRole !== newRole) {
              // Role has changed, update related collections
              if (newRole === USER_ROLES.CLIENT) {
                // Check if client record exists
                const clientDoc = await db.collection('clients').doc(userId).get();
                if (!clientDoc.exists) {
                  await db.collection('clients').doc(userId).set({
                    email: userDoc.data().email,
                    allowedBrands: [],
                    likes: [],
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                  });
                }
                
                // Remove agent record if exists
                const agentDoc = await db.collection('agents').doc(userId).get();
                if (agentDoc.exists) {
                  await db.collection('agents').doc(userId).delete();
                }
              } else if (newRole === USER_ROLES.AGENT) {
                // Check if agent record exists
                const agentDoc = await db.collection('agents').doc(userId).get();
                if (!agentDoc.exists) {
                  await db.collection('agents').doc(userId).set({
                    email: userDoc.data().email,
                    clients: [],
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                  });
                }
                
                // Make sure client record exists for agents
                const clientDoc = await db.collection('clients').doc(userId).get();
                if (!clientDoc.exists) {
                  await db.collection('clients').doc(userId).set({
                    email: userDoc.data().email,
                    allowedBrands: [],
                    likes: [],
                    agentId: userId, // Agents are their own agents
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                  });
                } else {
                  // Update existing client record to add agentId
                  await db.collection('clients').doc(userId).update({
                    agentId: userId
                  });
                }
              } else if (newRole === USER_ROLES.ADMIN) {
                // Make sure client record exists for admins
                const clientDoc = await db.collection('clients').doc(userId).get();
                if (!clientDoc.exists) {
                  await db.collection('clients').doc(userId).set({
                    email: userDoc.data().email,
                    allowedBrands: [],
                    likes: [],
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                  });
                }
                
                // Remove agent record if exists
                const agentDoc = await db.collection('agents').doc(userId).get();
                if (agentDoc.exists) {
                  await db.collection('agents').doc(userId).delete();
                }
              }
            }
            
            alert('砖转砖 注 爪');
            document.getElementById('edit-user-modal').style.display = 'none';
            loadUsers();
          } catch (error) {
            console.error('Error updating user:', error);
            alert(`砖 注 砖转砖: ${error.message}`);
          }
        });
        
        // Edit user delete
        document.getElementById('edit-user-delete').addEventListener('click', async () => {
          const userId = document.getElementById('edit-user-id').value;
          const userEmail = document.getElementById('edit-user-email').value;
          
          if (confirm(` 转  砖专爪 拽 转 砖转砖 ${userEmail}?`)) {
            try {
              // Check if user is not current user
              if (userId === auth.currentUser.uid) {
                alert('  拽 转 注爪');
                return;
              }
              
              // Delete user document from Firestore
              await db.collection('users').doc(userId).delete();
              
              // Delete client record if exists
              const clientDoc = await db.collection('clients').doc(userId).get();
              if (clientDoc.exists) {
                await db.collection('clients').doc(userId).delete();
              }
              
              // Delete agent record if exists
              const agentDoc = await db.collection('agents').doc(userId).get();
              if (agentDoc.exists) {
                await db.collection('agents').doc(userId).delete();
              }
              
              // Delete user from Authentication
              try {
                // This is normally done using admin SDK
                // For frontend, deactivate user instead
                alert('砖转砖 住专 住 转,   转 拽 转 拽转 转  砖转 Admin SDK');
              } catch (authError) {
                console.error('Error deleting auth user:', authError);
              }
              
              alert('砖转砖 拽 爪');
              document.getElementById('edit-user-modal').style.display = 'none';
              loadUsers();
            } catch (error) {
              console.error('Error deleting user:', error);
              alert(`砖 拽转 砖转砖: ${error.message}`);
            }
          }
        });
        
        // Update client form
        document.getElementById('update-client-form').addEventListener('submit', async (e) => {
          e.preventDefault();
          
          const clientId = document.getElementById('client-select').value;
          const agentId = document.getElementById('client-agent').value;
          
          if (!clientId) {
            alert(' 专 拽');
            return;
          }
          
          try {
              // Update client record
            const updates = {};
            
            if (agentId) {
              updates.agentId = agentId;
            } else {
              // If no agent is selected, remove the field
              updates.agentId = firebase.firestore.FieldValue.delete();
            }
            
            await db.collection('clients').doc(clientId).update(updates);
            
            // If agent is selected, update agent's clients array
            if (agentId) {
              // Check if agent document exists
              const agentDoc = await db.collection('agents').doc(agentId).get();
              
              if (agentDoc.exists) {
                // Add client to agent's clients array if not already there
                await db.collection('agents').doc(agentId).update({
                  clients: firebase.firestore.FieldValue.arrayUnion(clientId)
                });
              }
            }
            
            alert('驻专 拽 注 爪');
            loadClients();
          } catch (error) {
            console.error('Error updating client:', error);
            alert(`砖 注 拽: ${error.message}`);
          }
        });
        
        // Client select change - simplified to just set agent
        document.getElementById('client-select').addEventListener('change', async () => {
          const clientId = document.getElementById('client-select').value;
          
          if (clientId) {
            try {
              // Get client data
              const clientDoc = await db.collection('clients').doc(clientId).get();
              
              if (clientDoc.exists) {
                const clientData = clientDoc.data();
                
                // Set agent
                document.getElementById('client-agent').value = clientData.agentId || '';
              }
            } catch (error) {
              console.error('Error getting client data:', error);
            }
          }
        });
        
        // Search filters
        document.getElementById('users-search').addEventListener('input', (e) => {
          const searchTerm = e.target.value.toLowerCase();
          
          document.querySelectorAll('#users-table-body tr').forEach(row => {
            const email = row.querySelector('td:first-child').textContent.toLowerCase();
            const role = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
            
            if (email.includes(searchTerm) || role.includes(searchTerm)) {
              row.style.display = '';
            } else {
              row.style.display = 'none';
            }
          });
        });
        
        document.getElementById('clients-search').addEventListener('input', (e) => {
          const searchTerm = e.target.value.toLowerCase();
          
          document.querySelectorAll('#clients-table-body tr').forEach(row => {
            const email = row.querySelector('td:first-child').textContent.toLowerCase();
            const agent = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
            
            if (email.includes(searchTerm) || agent.includes(searchTerm)) {
              row.style.display = '';
            } else {
              row.style.display = 'none';
            }
          });
        });
        
        document.getElementById('agents-search').addEventListener('input', (e) => {
          const searchTerm = e.target.value.toLowerCase();
          
          document.querySelectorAll('#agents-table-body tr').forEach(row => {
            const email = row.querySelector('td:first-child').textContent.toLowerCase();
            
            if (email.includes(searchTerm)) {
              row.style.display = '';
            } else {
              row.style.display = 'none';
            }
          });
        });
        
        // Like filters
        document.getElementById('likes-client-filter').addEventListener('change', loadLikes);
        document.getElementById('likes-agent-filter').addEventListener('change', loadLikes);
      }
      
      // Load users
      async function loadUsers() {
        const usersTableBody = document.getElementById('users-table-body');
        usersTableBody.innerHTML = '<tr><td colspan="4" style="text-align: center;">注 砖转砖...</td></tr>';
        
        try {
          const usersSnapshot = await db.collection('users').get();
          
          if (usersSnapshot.empty) {
            usersTableBody.innerHTML = '<tr><td colspan="4" style="text-align: center;"> 砖转砖</td></tr>';
            return;
          }
          
          usersTableBody.innerHTML = '';
          
          usersSnapshot.forEach(doc => {
            const userData = doc.data();
            const row = document.createElement('tr');
            
            // Format role
            let roleText = '';
            switch (userData.role) {
              case USER_ROLES.ADMIN:
                roleText = '';
                break;
              case USER_ROLES.AGENT:
                roleText = '住';
                break;
              case USER_ROLES.CLIENT:
                roleText = '拽';
                break;
              default:
                roleText = userData.role || '';
            }
            
            // Format date
            let dateText = '';
            if (userData.createdAt) {
              const date = userData.createdAt.toDate();
              dateText = new Date(date).toLocaleDateString('he-IL');
            }
            
            row.innerHTML = `
              <td>${userData.email || ''}</td>
              <td>${roleText}</td>
              <td>${dateText}</td>
              <td>
                <button class="btn btn-primary edit-user-btn" data-id="${doc.id}">注专</button>
              </td>
            `;
            
            usersTableBody.appendChild(row);
          });
          
          // Add edit click handlers
          document.querySelectorAll('.edit-user-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
              const userId = btn.dataset.id;
              
              try {
                const userDoc = await db.collection('users').doc(userId).get();
                
                if (userDoc.exists) {
                  const userData = userDoc.data();
                  
                  // Populate edit form
                  document.getElementById('edit-user-id').value = userId;
                  document.getElementById('edit-user-email').value = userData.email || '';
                  document.getElementById('edit-user-role').value = userData.role || '';
                  document.getElementById('edit-user-password').value = '';
                  
                  // Show modal
                  document.getElementById('edit-user-modal').style.display = 'block';
                }
              } catch (error) {
                console.error('Error getting user data:', error);
                alert(`砖 注转 转 砖转砖: ${error.message}`);
              }
            });
          });
        } catch (error) {
          console.error('Error loading users:', error);
          usersTableBody.innerHTML = `<tr><td colspan="4" style="text-align: center; color: red;">砖 注转 砖转砖: ${error.message}</td></tr>`;
        }
      }
      
      // Load clients - only actual clients, not admins or agents
      async function loadClients() {
        const clientsTableBody = document.getElementById('clients-table-body');
        const clientSelect = document.getElementById('client-select');
        
        clientsTableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">注 拽转...</td></tr>';
        
        try {
          // Clear client select except first option
          clientSelect.innerHTML = '<option value="">-- 专 拽 --</option>';
          
          // First, get the list of users with the CLIENT role
          const clientUsersSnapshot = await db.collection('users')
            .where('role', '==', USER_ROLES.CLIENT)
            .get();
          
          if (clientUsersSnapshot.empty) {
            clientsTableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;"> 拽转</td></tr>';
            return;
          }
          
          // Get list of client user IDs
          const clientUserIds = clientUsersSnapshot.docs.map(doc => doc.id);
          
          // Now get the corresponding client records
          const clientsSnapshot = await db.collection('clients')
            .where(firebase.firestore.FieldPath.documentId(), 'in', clientUserIds)
            .get();
          
          if (clientsSnapshot.empty) {
            clientsTableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;"> 拽转</td></tr>';
            return;
          }
          
          clientsTableBody.innerHTML = '';
          
          // Map of agent IDs to emails
          const agentEmails = {};
          const agentsSnapshot = await db.collection('users')
            .where('role', '==', USER_ROLES.AGENT)
            .get();
          
          agentsSnapshot.forEach(doc => {
            agentEmails[doc.id] = doc.data().email;
          });
          
          // Load clients with agent info
          const clientsData = [];
          
          // Create a map of client user emails for quicker lookup
          const clientEmailMap = {};
          clientUsersSnapshot.forEach(doc => {
            clientEmailMap[doc.id] = doc.data().email || '';
          });
          
          // Gather client data with related user info
          for (const doc of clientsSnapshot.docs) {
            const clientData = doc.data();
            
            // Get user email from the map we created
            let userEmail = clientEmailMap[doc.id] || clientData.email || '';
            
            let createdDate = '';
            if (clientData.createdAt) {
              createdDate = new Date(clientData.createdAt.toDate()).toLocaleDateString('he-IL');
            }
            
            clientsData.push({
              id: doc.id,
              email: userEmail,
              agent: clientData.agentId ? (agentEmails[clientData.agentId] || 'Unknown') : '',
              agentId: clientData.agentId || '',
              createdDate: createdDate,
              likes: clientData.likes || []
            });
            
            // Add to client select
            const option = document.createElement('option');
            option.value = doc.id;
            option.textContent = userEmail;
            clientSelect.appendChild(option);
          }
          
          // Sort by email
          clientsData.sort((a, b) => a.email.localeCompare(b.email));
          
          // Display clients
          clientsData.forEach(client => {
            const row = document.createElement('tr');
            
            row.innerHTML = `
              <td>${client.email}</td>
              <td>${client.agent || ' 住'}</td>
              <td>${client.createdDate || ' 注'}</td>
              <td>${client.likes.length}</td>
              <td>
                <button class="btn btn-primary edit-client-btn" data-id="${client.id}">砖 住</button>
                <button class="btn btn-danger delete-client-btn" data-id="${client.id}" data-email="${client.email}">拽</button>
              </td>
            `;
            
            clientsTableBody.appendChild(row);
          });
          
          // Add edit click handlers
          document.querySelectorAll('.edit-client-btn').forEach(btn => {
            btn.addEventListener('click', () => {
              const clientId = btn.dataset.id;
              document.getElementById('client-select').value = clientId;
              
              // Trigger change event to load client data
              const event = new Event('change');
              document.getElementById('client-select').dispatchEvent(event);
              
              // Scroll to form
              document.querySelector('.admin-form').scrollIntoView({ behavior: 'smooth' });
            });
          });
          
          // Add delete click handlers
          document.querySelectorAll('.delete-client-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
              const clientId = btn.dataset.id;
              const clientEmail = btn.dataset.email;
              
              if (confirm(` 转  砖专爪 拽 转 拽 ${clientEmail}?`)) {
                try {
                  // Check if client has user record
                  const userDoc = await db.collection('users').doc(clientId).get();
                  
                  if (userDoc.exists) {
                    // Delete user record
                    await db.collection('users').doc(clientId).delete();
                  }
                  
                  // Delete client record
                  await db.collection('clients').doc(clientId).delete();
                  
                  alert(`拽 ${clientEmail} 拽 爪`);
                  loadClients(); // Reload client list
                } catch (error) {
                  console.error('Error deleting client:', error);
                  alert(`砖 拽转 拽: ${error.message}`);
                }
              }
            });
          });
        } catch (error) {
          console.error('Error loading clients:', error);
          clientsTableBody.innerHTML = `<tr><td colspan="5" style="text-align: center; color: red;">砖 注转 拽转: ${error.message}</td></tr>`;
        }
      }
      
      // Load agents
      async function loadAgents() {
        const agentsTableBody = document.getElementById('agents-table-body');
        
        agentsTableBody.innerHTML = '<tr><td colspan="4" style="text-align: center;">注 住...</td></tr>';
        
        try {
          // Get agents
          const agentsSnapshot = await db.collection('users')
            .where('role', '==', USER_ROLES.AGENT)
            .get();
          
          if (agentsSnapshot.empty) {
            agentsTableBody.innerHTML = '<tr><td colspan="4" style="text-align: center;"> 住</td></tr>';
            return;
          }
          
          agentsTableBody.innerHTML = '';
          
          // For each agent, get their clients count
          for (const doc of agentsSnapshot.docs) {
            const agentData = doc.data();
            
            // Get clients for this agent
            const clientsSnapshot = await db.collection('clients')
              .where('agentId', '==', doc.id)
              .get();
            
            const clientsCount = clientsSnapshot.size;
            
            // Format date
            let dateText = '';
            if (agentData.createdAt) {
              const date = agentData.createdAt.toDate();
              dateText = new Date(date).toLocaleDateString('he-IL');
            }
            
            const row = document.createElement('tr');
            
            row.innerHTML = `
              <td>${agentData.email || ''}</td>
              <td>${clientsCount}</td>
              <td>${dateText}</td>
              <td>
                <button class="btn btn-primary view-agent-clients-btn" data-id="${doc.id}">拽转 住</button>
              </td>
            `;
            
            agentsTableBody.appendChild(row);
          }
          
          // Add view clients click handlers
          document.querySelectorAll('.view-agent-clients-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
              const agentId = btn.dataset.id;
              
              try {
                const clientsSnapshot = await db.collection('clients')
                  .where('agentId', '==', agentId)
                  .get();
                
                const clientEmails = [];
                
                clientsSnapshot.forEach(doc => {
                  const clientData = doc.data();
                  clientEmails.push(clientData.email || 'Unknown');
                });
                
                if (clientEmails.length > 0) {
                  alert(`拽转 住:\n${clientEmails.join('\n')}`);
                } else {
                  alert(' 拽转 住 ');
                }
              } catch (error) {
                console.error('Error getting agent clients:', error);
                alert(`砖 注转 拽转 住: ${error.message}`);
              }
            });
          });
        } catch (error) {
          console.error('Error loading agents:', error);
          agentsTableBody.innerHTML = `<tr><td colspan="4" style="text-align: center; color: red;">砖 注转 住: ${error.message}</td></tr>`;
        }
      }
      
      // Load registration requests
      async function loadRegistrationRequests() {
        const registrationTableBody = document.getElementById('registration-table-body');
        
        registrationTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">注 拽砖转 专砖...</td></tr>';
        
        try {
          const requestsSnapshot = await db.collection('registrationRequests')
            .orderBy('createdAt', 'desc')
            .get();
          
          if (requestsSnapshot.empty) {
            registrationTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;"> 拽砖转 专砖</td></tr>';
            return;
          }
          
          registrationTableBody.innerHTML = '';
          
          requestsSnapshot.forEach(doc => {
            const requestData = doc.data();
            
            // Format role
            let roleText = '';
            switch (requestData.requestedRole) {
              case USER_ROLES.ADMIN:
                roleText = '';
                break;
              case USER_ROLES.AGENT:
                roleText = '住';
                break;
              case USER_ROLES.CLIENT:
                roleText = '拽';
                break;
              default:
                roleText = requestData.requestedRole || '';
            }
            
            // Format status
            let statusText = '';
            let statusClass = '';
            switch (requestData.status) {
              case 'approved':
                statusText = '砖专';
                statusClass = 'badge-success';
                break;
              case 'rejected':
                statusText = '';
                statusClass = 'badge-danger';
                break;
              case 'pending':
              default:
                statusText = '转';
                statusClass = 'badge-warning';
            }
            
            // Format date
            let dateText = '';
            if (requestData.createdAt) {
              const date = requestData.createdAt.toDate();
              dateText = new Date(date).toLocaleDateString('he-IL');
            }
            
            const row = document.createElement('tr');
            
            row.innerHTML = `
              <td>${requestData.name || ''}</td>
              <td>${requestData.email || ''}</td>
              <td>${roleText}</td>
              <td><span class="badge ${statusClass}">${statusText}</span></td>
              <td>${dateText}</td>
              <td>
                ${requestData.status === 'pending' ? `
                  <button class="btn btn-success approve-request-btn" data-id="${doc.id}">砖专</button>
                  <button class="btn btn-danger reject-request-btn" data-id="${doc.id}"></button>
                ` : ''}
              </td>
            `;
            
            registrationTableBody.appendChild(row);
          });
          
          // Add approve click handlers
          document.querySelectorAll('.approve-request-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
              const requestId = btn.dataset.id;
              
              try {
                const requestDoc = await db.collection('registrationRequests').doc(requestId).get();
                
                if (requestDoc.exists) {
                  const requestData = requestDoc.data();
                  
                  if (confirm(` 砖专 转 拽砖转 专砖 砖 ${requestData.name} (${requestData.email})?`)) {
                    // Create user in Firebase Authentication
                    const userCredential = await firebase.auth().createUserWithEmailAndPassword(
                      requestData.email, 
                      requestData.password
                    );
                    const newUser = userCredential.user;
                    
                    // Create user document in Firestore
                    await db.collection('users').doc(newUser.uid).set({
                      email: requestData.email,
                      role: requestData.requestedRole,
                      createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Create additional documents based on role
                    if (requestData.requestedRole === USER_ROLES.CLIENT) {
                      await db.collection('clients').doc(newUser.uid).set({
                        email: requestData.email,
                        allowedBrands: [],
                        likes: [],
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                      });
                    } else if (requestData.requestedRole === USER_ROLES.AGENT) {
                      await db.collection('agents').doc(newUser.uid).set({
                        email: requestData.email,
                        clients: [],
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                      });
                      
                      // Agents also get a client record for their own likes
                      await db.collection('clients').doc(newUser.uid).set({
                        email: requestData.email,
                        allowedBrands: [],
                        likes: [],
                        agentId: newUser.uid, // Agents are their own agents
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                      });
                    }
                    
                    // Update request status
                    await db.collection('registrationRequests').doc(requestId).update({
                      status: 'approved',
                      approvedAt: firebase.firestore.FieldValue.serverTimestamp(),
                      approvedBy: auth.currentUser.uid
                    });
                    
                    alert(`拽砖转 专砖 砖专 爪专 砖转砖: ${requestData.email}`);
                    loadRegistrationRequests();
                  }
                }
              } catch (error) {
                console.error('Error approving registration request:', error);
                alert(`砖 砖专 拽砖转 专砖: ${error.message}`);
              }
            });
          });
          
          // Add reject click handlers
          document.querySelectorAll('.reject-request-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
              const requestId = btn.dataset.id;
              
              try {
                const requestDoc = await db.collection('registrationRequests').doc(requestId).get();
                
                if (requestDoc.exists) {
                  const requestData = requestDoc.data();
                  
                  if (confirm(` 转 转 拽砖转 专砖 砖 ${requestData.name} (${requestData.email})?`)) {
                    // Update request status
                    await db.collection('registrationRequests').doc(requestId).update({
                      status: 'rejected',
                      rejectedAt: firebase.firestore.FieldValue.serverTimestamp(),
                      rejectedBy: auth.currentUser.uid
                    });
                    
                    alert(`拽砖转 专砖 转`);
                    loadRegistrationRequests();
                  }
                }
              } catch (error) {
                console.error('Error rejecting registration request:', error);
                alert(`砖 转 拽砖转 专砖: ${error.message}`);
              }
            });
          });
        } catch (error) {
          console.error('Error loading registration requests:', error);
          registrationTableBody.innerHTML = `<tr><td colspan="6" style="text-align: center; color: red;">砖 注转 拽砖转 专砖: ${error.message}</td></tr>`;
        }
      }
      
      // Load likes
      async function loadLikes() {
        const likesDashboard = document.getElementById('likes-dashboard');
        
        if (!likesDashboard) {
          console.error('Likes dashboard element not found');
          return;
        }
        
        likesDashboard.innerHTML = '<div style="text-align: center; grid-column: 1 / -1;">注 注驻...</div>';
        
        // Ensure client filter is populated
        await loadClientsForLikesFilter();
        
        // After populating, get the values
        const clientFilter = document.getElementById('likes-client-filter')?.value || '';
        const agentFilter = document.getElementById('likes-agent-filter')?.value || '';
        
        try {
          // Build query based on filters
          let clientsQuery = db.collection('clients');
          
          if (agentFilter) {
            clientsQuery = clientsQuery.where('agentId', '==', agentFilter);
          }
          
          let clientsSnapshot;
          
          if (clientFilter) {
            console.log('Filtering by client ID:', clientFilter);
            // When filtering by client, get just that specific client document rather than using a where clause
            // This fixes the issue with the client filter not working
            const clientDoc = await db.collection('clients').doc(clientFilter).get();
            
            if (!clientDoc.exists) {
              likesDashboard.innerHTML = '<div style="text-align: center; grid-column: 1 / -1;">拽 砖专  爪</div>';
              return;
            }
            
            // Check if agent filter exists and matches
            if (agentFilter && clientDoc.data().agentId !== agentFilter) {
              likesDashboard.innerHTML = '<div style="text-align: center; grid-column: 1 / -1;">拽 砖专  砖 住 砖专</div>';
              return;
            }
            
            // Create a custom snapshot-like object with just this client
            clientsSnapshot = {
              empty: false,
              docs: [clientDoc],
              forEach: function(callback) {
                callback(clientDoc);
              }
            };
          } else {
            // No client filter, use regular query
            clientsSnapshot = await clientsQuery.get();
          }
          
          if (clientsSnapshot.empty) {
            likesDashboard.innerHTML = '<div style="text-align: center; grid-column: 1 / -1;"> 爪 拽转</div>';
            return;
          }
          
          // Get all liked products
          const allLikes = [];
          const clientsMap = {};
          
          clientsSnapshot.forEach(doc => {
            const clientData = doc.data();
            const likes = clientData.likes || [];
            
            clientsMap[doc.id] = clientData.email || 'Unknown';
            
            likes.forEach(barcode => {
              allLikes.push({
                barcode,
                clientId: doc.id,
                clientEmail: clientData.email || 'Unknown'
              });
            });
          });
          
          if (allLikes.length === 0) {
            likesDashboard.innerHTML = '<div style="text-align: center; grid-column: 1 / -1;"> 爪 爪专 注驻</div>';
            return;
          }
          
          // Clear dashboard
          likesDashboard.innerHTML = '';
          
          // Group likes by barcode
          const groupedLikes = {};
          
          allLikes.forEach(like => {
            if (!groupedLikes[like.barcode]) {
              groupedLikes[like.barcode] = {
                barcode: like.barcode,
                clients: []
              };
            }
            
            groupedLikes[like.barcode].clients.push({
              id: like.clientId,
              email: like.clientEmail
            });
          });
          
          // Create product cards
          Object.values(groupedLikes).forEach(product => {
            const card = document.createElement('div');
            card.className = 'like-card';
            
            card.innerHTML = `
              <img src="tl/${product.barcode}.jpg" alt="Product" class="like-image" onerror="if(this.src.includes('tl/')){ this.src='media/${product.barcode}.jpg'; } else if(this.src.includes('media/')){ this.src='images/logo.png'; this.style.opacity='0.5'; }">
              <div class="like-info">
                <div class="like-title">拽": ${product.barcode}</div>
                <div class="like-details">住驻专 拽转: ${product.clients.length}</div>
                <div class="like-client">${product.clients.map(c => c.email).join(', ')}</div>
              </div>
            `;
            
            likesDashboard.appendChild(card);
          });
        } catch (error) {
          console.error('Error loading likes:', error);
          likesDashboard.innerHTML = `<div style="text-align: center; grid-column: 1 / -1; color: red;">砖 注转 注驻: ${error.message}</div>`;
        }
      }
      
      // Load agents for select
      async function loadAgentsForSelect() {
        const agentSelect = document.getElementById('client-agent');
        const likesAgentFilter = document.getElementById('likes-agent-filter');
        
        try {
          // Clear agent select except first option
          agentSelect.innerHTML = '<option value="">--  住 --</option>';
          
          // Clear likes agent filter except first option
          likesAgentFilter.innerHTML = '<option value=""> 住</option>';
          
          const agentsSnapshot = await db.collection('users')
            .where('role', '==', USER_ROLES.AGENT)
            .get();
          
          if (agentsSnapshot.empty) {
            return;
          }
          
          agentsSnapshot.forEach(doc => {
            const agentData = doc.data();
            
            // Add to agent select
            const option = document.createElement('option');
            option.value = doc.id;
            option.textContent = agentData.email || doc.id;
            agentSelect.appendChild(option);
            
            // Add to likes agent filter
            const filterOption = document.createElement('option');
            filterOption.value = doc.id;
            filterOption.textContent = agentData.email || doc.id;
            likesAgentFilter.appendChild(filterOption);
          });
        } catch (error) {
          console.error('Error loading agents for select:', error);
        }
      }
      
      // Load brands for multiselect from all API sources
      async function loadBrandsForMultiselect() {
        // These elements may not exist anymore, so check before accessing
        const brandsCheckboxList = document.getElementById('brands-checkbox-list');
        const brandsFilter = document.getElementById('brands-filter');
        const selectAllCheckbox = document.getElementById('select-all-brands');
        
        // First load clients for likes filter (which still exists)
        try {
          await loadClientsForLikesFilter();
        } catch (error) {
          console.error('Error loading clients for likes filter:', error);
        }
        
        // If the multiselect elements don't exist, return early
        if (!brandsCheckboxList || !brandsFilter || !selectAllCheckbox) {
          console.log('Multiselect elements not found, skipping brands load');
          return;
        }
        
        // Show loading state
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'multiselect-loading';
        loadingDiv.innerHTML = '<div class="spinner"></div> 注 拽转...';
        loadingDiv.style.gridColumn = '1 / -1';
        loadingDiv.style.textAlign = 'center';
        loadingDiv.style.padding = '20px';
        
        // Clear existing content except filter and select all
        const existingFilter = brandsCheckboxList.querySelector('.multiselect-filter');
        const existingSelectAll = brandsCheckboxList.querySelector('.multiselect-select-all');
        brandsCheckboxList.innerHTML = '';
        brandsCheckboxList.appendChild(existingFilter);
        brandsCheckboxList.appendChild(existingSelectAll);
        brandsCheckboxList.appendChild(loadingDiv);
        
        try {
          // Define all CSV URLs
          const CSV_URLS = {
            brands: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRbLyJcDTPOjBtcGOSKUXYuKn5U8_sRF_KOSgFwiyPoeO3YazAxOhXXVCSK7M94-yxyO7j1fr5J3ou_/pub?output=csv',
            alcohol: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRGNZzh1kbP8nYSiVNDDsd198zJoo6725-WKPz7YUE-lVWXkdjn0r97SJAEOttnLoqAH5PSJRbDbRiB/pub?output=csv',
            wine: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRkUmKUxQGkMSoLEhfkgdXBU6KGDDea6Z8crHPVeFEsYajhCUmSQevyTL_9WucAyhw2UnDfoFQXURCB/pub?output=csv',
            beer: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQGFPOHiYkWGPDASiBePqXkbxoikcLYiFAz1RobyVTlX2-dj71jMSCCFLgrNXOjFpOZYwS7MHCD6IrU/pub?output=csv',
            food: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS5zrZyn-cmKHuk3H-nI4QG9NDJFvB-q3MjjdIUuQfk_lhtQPzTeovn_kAz46o2PnuH_aZ8Mq1zteFD/pub?output=csv',
            whiskey: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSnSgqeW3W-2vKiqPwsBLpOE9vamrHELbgZCNHDYv6bGGYPnkhp44KzYvbly7qCLq3E_Rgu2VyYKMGY/pub?output=csv'
          };
          
          // Function to extract client column names from CSV
          const extractClientColumns = async (url) => {
            try {
              const response = await fetch(url);
              
              if (!response.ok) {
                console.warn(`Error loading CSV from ${url}:`, response.status);
                return [];
              }
              
              const text = await response.text();
              const lines = text.split('\n');
              
              if (lines.length === 0) {
                return [];
              }
              
              // Get header row and find columns that could be client names
              const headers = lines[0].split(',');
              
              // For each product row, check if any column contains "TRUE" values
              // These are likely client columns
              const clientColumns = new Set();
              
              for (let i = 1; i < Math.min(lines.length, 20); i++) { // Check first 20 rows at most
                if (!lines[i].trim()) continue;
                
                const values = lines[i].split(',');
                
                headers.forEach((header, index) => {
                  const value = values[index];
                  if (value && (value.trim().toUpperCase() === 'TRUE' || value.trim().toUpperCase() === '"TRUE"')) {
                    clientColumns.add(header.trim().replace(/^"|"$/g, ''));
                  }
                });
              }
              
              return Array.from(clientColumns);
            } catch (error) {
              console.warn(`Error extracting client columns from ${url}:`, error);
              return [];
            }
          };
          
          // Collect client names from the main brands CSV
          let allBrands = new Set();
          
          // Step 1: Start with the primary brands list
          try {
            const response = await fetch(CSV_URLS.brands);
            
            if (response.ok) {
              const text = await response.text();
              const brands = text.split('\n')
                .filter(line => line.trim())
                .map(line => line.trim());
              
              brands.forEach(brand => allBrands.add(brand));
            }
          } catch (error) {
            console.warn('Error loading primary brands list:', error);
          }
          
          // Step 2: Extract client columns from all product CSVs
          const productCSVs = ['alcohol', 'wine', 'beer', 'food', 'whiskey'];
          const extractPromises = productCSVs.map(key => extractClientColumns(CSV_URLS[key]));
          const clientColumnsArrays = await Promise.all(extractPromises);
          
          // Combine all client columns from all CSVs
          clientColumnsArrays.forEach(columns => {
            columns.forEach(column => allBrands.add(column));
          });
          
          // Convert Set to sorted array
          const sortedBrands = Array.from(allBrands).sort((a, b) => 
            a.localeCompare(b, 'he-IL')
          );
          
          if (sortedBrands.length === 0) {
            brandsCheckboxList.removeChild(loadingDiv);
            const noDataDiv = document.createElement('div');
            noDataDiv.style.gridColumn = '1 / -1';
            noDataDiv.style.textAlign = 'center';
            noDataDiv.textContent = ' 爪 拽转';
            brandsCheckboxList.appendChild(noDataDiv);
            return;
          }
          
          // Remove loading indicator
          brandsCheckboxList.removeChild(loadingDiv);
          
          // Add brands as checkboxes
          sortedBrands.forEach(brand => {
            const option = document.createElement('div');
            option.className = 'multiselect-option';
            
            const id = `brand-${brand.replace(/[^a-zA-Z0-9-转]/g, '-')}`;
            
            option.innerHTML = `
              <input type="checkbox" class="multiselect-checkbox" value="${brand}" id="${id}">
              <label for="${id}" title="${brand}">${brand}</label>
            `;
            
            brandsCheckboxList.appendChild(option);
          });
          
          // Add filter functionality
          brandsFilter.addEventListener('input', () => {
            const filterValue = brandsFilter.value.toLowerCase();
            
            document.querySelectorAll('.multiselect-option').forEach(option => {
              if (option.closest('.multiselect-select-all')) return; // Skip select all row
              
              const label = option.querySelector('label');
              const brandName = label.textContent.toLowerCase();
              
              if (brandName.includes(filterValue)) {
                option.style.display = '';
              } else {
                option.style.display = 'none';
              }
            });
          });
          
          // Add select all functionality
          selectAllCheckbox.addEventListener('change', () => {
            const isChecked = selectAllCheckbox.checked;
            
            // Only affect visible checkboxes (respecting filter)
            document.querySelectorAll('.multiselect-option:not([style*="display: none"]) .multiselect-checkbox').forEach(checkbox => {
              checkbox.checked = isChecked;
            });
          });
          
          // Update select all state when individual checkboxes change
          document.querySelectorAll('.multiselect-checkbox').forEach(checkbox => {
            if (checkbox.id === 'select-all-brands') return; // Skip select all checkbox
            
            checkbox.addEventListener('change', updateSelectAllState);
          });
          
          // Function to update select all checkbox state
          function updateSelectAllState() {
            const visibleCheckboxes = Array.from(
              document.querySelectorAll('.multiselect-option:not([style*="display: none"]) .multiselect-checkbox')
            ).filter(cb => cb.id !== 'select-all-brands');
            
            const allChecked = visibleCheckboxes.every(cb => cb.checked);
            const someChecked = visibleCheckboxes.some(cb => cb.checked);
            
            selectAllCheckbox.checked = allChecked;
            selectAllCheckbox.indeterminate = someChecked && !allChecked;
          }
          
          // Client loading is now handled by loadClientsForLikesFilter() function
        } catch (error) {
          console.error('Error loading brands for multiselect:', error);
          brandsDropdown.innerHTML = '<div class="multiselect-option">砖 注转 拽转</div>';
        }
      }
      
      // Load agents for user form
      async function loadAgentsForUserForm() {
        const agentSelect = document.getElementById('user-agent');
        if (!agentSelect) return;
        
        console.log('Loading agents for user form');
        
        // Reset dropdown content
        agentSelect.innerHTML = '<option value="">--  住 --</option>';
        
        try {
          const agentsSnapshot = await db.collection('users')
            .where('role', '==', USER_ROLES.AGENT)
            .get();
          
          if (agentsSnapshot.empty) {
            console.log('No agents found');
            return;
          }
          
          const agentsData = [];
          
          agentsSnapshot.forEach(doc => {
            const agentData = doc.data();
            agentsData.push({
              id: doc.id,
              email: agentData.email || doc.id
            });
          });
          
          // Sort by email
          agentsData.sort((a, b) => a.email.localeCompare(b.email));
          
          console.log(`Found ${agentsData.length} agents`);
          
          // Create HTML for all options
          let optionsHTML = '';
          
          agentsData.forEach(agent => {
            // For very long email addresses, truncate for display
            const emailText = agent.email;
            const maxLength = 30;
            
            let displayText;
            if (emailText.length > maxLength) {
              const firstPart = emailText.substring(0, 15);
              const lastPart = emailText.substring(emailText.length - 15);
              displayText = `${firstPart}...${lastPart}`;
            } else {
              displayText = emailText;
            }
            
            // Add option with full email as title for hover tooltip
            optionsHTML += `<option value="${agent.id}" title="${emailText}">${displayText}</option>`;
          });
          
          // Add all options to select at once (more efficient)
          agentSelect.innerHTML += optionsHTML;
          
        } catch (error) {
          console.error('Error loading agents for user form:', error);
        }
      }
      
      // Load clients for likes filter
      async function loadClientsForLikesFilter() {
        const likesClientFilter = document.getElementById('likes-client-filter');
        if (!likesClientFilter) {
          console.log('Likes client filter element not found');
          return;
        }
        
        likesClientFilter.innerHTML = '<option value=""> 拽转</option>';
        
        try {
          // Get only actual client users (not admins or agents)
          const clientsSnapshot = await db.collection('users')
            .where('role', '==', USER_ROLES.CLIENT)
            .get();
          
          if (!clientsSnapshot.empty) {
            const clientsData = [];
            
            for (const doc of clientsSnapshot.docs) {
              const userData = doc.data();
              const userEmail = userData.email || '';
              
              // Check if there's a corresponding client record
              try {
                const clientDoc = await db.collection('clients').doc(doc.id).get();
                if (clientDoc.exists && userEmail) {
                  clientsData.push({
                    id: doc.id,
                    email: userEmail
                  });
                }
              } catch (clientError) {
                console.error('Error getting client data:', clientError);
              }
            }
            
            // Sort by email
            clientsData.sort((a, b) => a.email.localeCompare(b.email));
            
            // Add to select
            clientsData.forEach(client => {
              const option = document.createElement('option');
              option.value = client.id;
              option.textContent = client.email;
              likesClientFilter.appendChild(option);
            });
            
            console.log('Loaded', clientsData.length, 'clients for likes filter');
          } else {
            console.log('No clients found');
          }
        } catch (error) {
          console.error('Error loading clients for likes filter:', error);
        }
      }
      
      // Load agents for recovery form
      async function loadAgentsForRecoveryForm() {
        const missingUserAgent = document.getElementById('missing-user-agent');
        if (!missingUserAgent) return;
        
        // Keep only the first option (empty)
        missingUserAgent.innerHTML = '<option value="">--  住 --</option>';
        
        try {
          const agentsSnapshot = await db.collection('users')
            .where('role', '==', USER_ROLES.AGENT)
            .get();
          
          if (agentsSnapshot.empty) {
            return;
          }
          
          const agentsData = [];
          
          agentsSnapshot.forEach(doc => {
            const agentData = doc.data();
            agentsData.push({
              id: doc.id,
              email: agentData.email || doc.id
            });
          });
          
          // Sort by email
          agentsData.sort((a, b) => a.email.localeCompare(b.email));
          
          // Add options to select
          agentsData.forEach(agent => {
            const option = document.createElement('option');
            option.value = agent.id;
            option.textContent = agent.email;
            missingUserAgent.appendChild(option);
          });
          
        } catch (error) {
          console.error('Error loading agents for recovery form:', error);
        }
      }
      
      // Setup recovery functionality
      document.addEventListener('DOMContentLoaded', function() {
        // Check if elements exist (they might not be loaded yet when this runs)
        const checkBtn = document.getElementById('check-missing-user-btn');
        const recoverBtn = document.getElementById('recover-missing-user-btn');
        const scanBtn = document.getElementById('scan-all-users-btn');
        
        if (checkBtn) {
          checkBtn.addEventListener('click', checkMissingUser);
        }
        
        if (recoverBtn) {
          recoverBtn.addEventListener('click', recoverMissingUser);
        }
        
        if (scanBtn) {
          scanBtn.addEventListener('click', scanAllUsers);
        }
      });
      
      // Function to check if a user exists in Auth but not in Firestore
      async function checkMissingUser() {
        const email = document.getElementById('missing-user-email').value;
        const resultsDiv = document.getElementById('recovery-results');
        const statusDiv = document.getElementById('recovery-status');
        const recoverBtn = document.getElementById('recover-missing-user-btn');
        
        if (!email) {
          alert('   拽');
          return;
        }
        
        statusDiv.style.display = 'block';
        resultsDiv.innerHTML = '<div style="text-align: center;"><div class="spinner"></div> 拽 砖转砖...</div>';
        recoverBtn.disabled = true;
        
        try {
          // First check if user exists in Authentication
          const signInMethods = await firebase.auth().fetchSignInMethodsForEmail(email);
          const userExistsInAuth = signInMethods && signInMethods.length > 0;
          
          if (!userExistsInAuth) {
            resultsDiv.innerHTML = `<p style="color: red;">砖转砖 ${email}  爪 注专转 转.</p>`;
            return;
          }
          
          // Check if user exists in Firestore users collection
          const usersSnapshot = await db.collection('users')
            .where('email', '==', email)
            .get();
          
          const userExistsInFirestore = !usersSnapshot.empty;
          let userId = null;
          
          if (userExistsInFirestore) {
            userId = usersSnapshot.docs[0].id;
            
            // Check if user has the corresponding role-specific documents
            const userDoc = usersSnapshot.docs[0];
            const userData = userDoc.data();
            const userRole = userData.role;
            
            if (userRole === USER_ROLES.CLIENT) {
              const clientDoc = await db.collection('clients').doc(userId).get();
              if (clientDoc.exists) {
                resultsDiv.innerHTML = `
                  <p style="color: green;">砖转砖 ${email} 拽 注专转 转 住 转.</p>
                  <p>转驻拽: 拽</p>
                  <p> 住 专砖 拽.</p>
                `;
                return;
              } else {
                resultsDiv.innerHTML = `
                  <p style="color: orange;">砖转砖 ${email} 拽 注专转 转 住祝 'users',  住 拽 砖 住专.</p>
                  <p>转驻拽: 拽</p>
                  <p>专砖 住祝 住 拽.</p>
                `;
                recoverBtn.disabled = false;
                window.missingUserData = {
                  email,
                  userId,
                  role: userRole
                };
                return;
              }
            } else if (userRole === USER_ROLES.AGENT) {
              const agentDoc = await db.collection('agents').doc(userId).get();
              const clientDoc = await db.collection('clients').doc(userId).get();
              
              if (agentDoc.exists && clientDoc.exists) {
                resultsDiv.innerHTML = `
                  <p style="color: green;">砖转砖 ${email} 拽 注专转 转 住 转.</p>
                  <p>转驻拽: 住</p>
                  <p> 住 专砖 拽.</p>
                `;
                return;
              } else {
                resultsDiv.innerHTML = `
                  <p style="color: orange;">砖转砖 ${email} 拽 注专转 转 住祝 'users',  ${!agentDoc.exists ? '住 住' : '住 拽'} 砖 住专.</p>
                  <p>转驻拽: 住</p>
                  <p>专砖 住祝 住 住专.</p>
                `;
                recoverBtn.disabled = false;
                window.missingUserData = {
                  email,
                  userId,
                  role: userRole
                };
                return;
              }
            } else if (userRole === USER_ROLES.ADMIN) {
              const clientDoc = await db.collection('clients').doc(userId).get();
              
              if (clientDoc.exists) {
                resultsDiv.innerHTML = `
                  <p style="color: green;">砖转砖 ${email} 拽 注专转 转 住 转.</p>
                  <p>转驻拽: </p>
                  <p> 住 专砖 拽.</p>
                `;
                return;
              } else {
                resultsDiv.innerHTML = `
                  <p style="color: orange;">砖转砖 ${email} 拽 注专转 转 住祝 'users',  住 拽 砖 住专.</p>
                  <p>转驻拽: </p>
                  <p>专砖 住祝 住 拽.</p>
                `;
                recoverBtn.disabled = false;
                window.missingUserData = {
                  email,
                  userId,
                  role: userRole
                };
                return;
              }
            }
          } else {
            // User exists in Auth but not in Firestore
            resultsDiv.innerHTML = `
              <p style="color: red;">砖转砖 ${email} 拽 注专转 转   住 转!</p>
              <p>专砖 砖专 转  住.</p>
            `;
            recoverBtn.disabled = false;
            
            // Need to get the UID from auth somehow - cannot directly with client SDK
            // We'll set a flag to create new documents during recovery
            window.missingUserData = {
              email,
              userId: null, // Will create a new one during recovery
              role: document.getElementById('missing-user-role').value
            };
            return;
          }
        } catch (error) {
          console.error('Error checking missing user:', error);
          resultsDiv.innerHTML = `<p style="color: red;">砖 拽转 砖转砖: ${error.message}</p>`;
        }
      }
      
      // Function to recover a missing user
      async function recoverMissingUser() {
        const resultsDiv = document.getElementById('recovery-results');
        const recoverBtn = document.getElementById('recover-missing-user-btn');
        const missingUserRole = document.getElementById('missing-user-role').value;
        const missingUserEmail = document.getElementById('missing-user-email').value;
        
        if (!window.missingUserData) {
          alert(' 爪注 拽转 砖转砖 转');
          return;
        }
        
        recoverBtn.disabled = true;
        resultsDiv.innerHTML = '<div style="text-align: center;"><div class="spinner"></div> 砖专 砖转砖...</div>';
        
        try {
          const {email, userId, role} = window.missingUserData;
          let actualUserId = userId;
          
          // If no userId, we need to find or create it
          if (!actualUserId) {
            // Try to find user by email first
            const usersSnapshot = await db.collection('users')
              .where('email', '==', email)
              .get();
            
            if (!usersSnapshot.empty) {
              actualUserId = usersSnapshot.docs[0].id;
            } else {
              // Create a new user document with a custom ID (not ideal but workable)
              // In a real system with Admin SDK, we'd get the actual UID from Auth
              actualUserId = db.collection('users').doc().id;
              
              // Create the user document first
              await db.collection('users').doc(actualUserId).set({
                email: email,
                role: missingUserRole,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
              });
            }
          }
          
          // Create role-specific documents
          if (missingUserRole === USER_ROLES.CLIENT) {
            // Check if a client document already exists
            const clientDoc = await db.collection('clients').doc(actualUserId).get();
            
            if (!clientDoc.exists) {
              // Need to create a client document
              const selectedAgentId = document.getElementById('missing-user-agent').value;
              
              if (!selectedAgentId && missingUserRole === USER_ROLES.CLIENT) {
                alert(' 专 住 注专 拽');
                recoverBtn.disabled = false;
                return;
              }
              
              // Create client document
              const clientData = {
                email: email,
                allowedBrands: [],
                likes: [],
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
              };
              
              if (selectedAgentId) {
                clientData.agentId = selectedAgentId;
                
                // Update agent's client list
                await db.collection('agents').doc(selectedAgentId).update({
                  clients: firebase.firestore.FieldValue.arrayUnion(actualUserId)
                }).catch(error => {
                  console.error('Error updating agent\'s client list:', error);
                });
              }
              
              await db.collection('clients').doc(actualUserId).set(clientData);
              
              resultsDiv.innerHTML = `
                <p style="color: green;">砖转砖 ${email} 砖专 爪!</p>
                <p>爪专 住 拽 砖.</p>
              `;
            } else {
              resultsDiv.innerHTML = `
                <p style="color: green;">住 拽 砖 ${email} 专 拽.</p>
              `;
            }
          } else if (missingUserRole === USER_ROLES.AGENT) {
            // Check if agent document exists
            const agentDoc = await db.collection('agents').doc(actualUserId).get();
            
            if (!agentDoc.exists) {
              // Create agent document
              await db.collection('agents').doc(actualUserId).set({
                email: email,
                clients: [],
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
              });
            }
            
            // Check if client document exists for this agent
            const clientDoc = await db.collection('clients').doc(actualUserId).get();
            
            if (!clientDoc.exists) {
              // Create client document for agent
              await db.collection('clients').doc(actualUserId).set({
                email: email,
                allowedBrands: [],
                likes: [],
                agentId: actualUserId, // Agents are their own agents
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
              });
            }
            
            resultsDiv.innerHTML = `
              <p style="color: green;">砖转砖 ${email} 砖专 爪!</p>
              <p>爪专  住 专砖 住.</p>
            `;
          } else if (missingUserRole === USER_ROLES.ADMIN) {
            // Check if client document exists for admin
            const clientDoc = await db.collection('clients').doc(actualUserId).get();
            
            if (!clientDoc.exists) {
              // Create client document for admin
              await db.collection('clients').doc(actualUserId).set({
                email: email,
                allowedBrands: [],
                likes: [],
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
              });
            }
            
            resultsDiv.innerHTML = `
              <p style="color: green;">砖转砖 ${email} 砖专 爪!</p>
              <p>爪专  住 专砖 .</p>
            `;
          }
          
          // Clear the recovery data
          window.missingUserData = null;
          recoverBtn.disabled = true;
        } catch (error) {
          console.error('Error recovering user:', error);
          resultsDiv.innerHTML = `<p style="color: red;">砖 砖专 砖转砖: ${error.message}</p>`;
          recoverBtn.disabled = false;
        }
      }
      
      // Function to scan all users
      async function scanAllUsers() {
        const missingUsersList = document.getElementById('missing-users-list');
        const scanResults = document.getElementById('scan-results');
        
        scanResults.style.display = 'block';
        missingUsersList.innerHTML = '<div style="text-align: center;"><div class="spinner"></div> 住专拽 砖转砖...</div>';
        
        try {
          // We can't directly get all auth users from client SDK
          // Instead, let's look for inconsistent user records
          
          // Get all users from the users collection
          const usersSnapshot = await db.collection('users').get();
          
          if (usersSnapshot.empty) {
            missingUsersList.innerHTML = '<p> 爪 砖转砖 住 转.</p>';
            return;
          }
          
          const missingDocs = [];
          
          // Check each user for missing documents
          for (const doc of usersSnapshot.docs) {
            const userData = doc.data();
            const userRole = userData.role;
            const userEmail = userData.email;
            
            // Check for role-specific documents
            if (userRole === USER_ROLES.CLIENT) {
              const clientDoc = await db.collection('clients').doc(doc.id).get();
              if (!clientDoc.exists) {
                missingDocs.push({
                  email: userEmail,
                  id: doc.id,
                  role: userRole,
                  missing: '住 拽'
                });
              }
            } else if (userRole === USER_ROLES.AGENT) {
              const agentDoc = await db.collection('agents').doc(doc.id).get();
              const clientDoc = await db.collection('clients').doc(doc.id).get();
              
              if (!agentDoc.exists) {
                missingDocs.push({
                  email: userEmail,
                  id: doc.id,
                  role: userRole,
                  missing: '住 住'
                });
              }
              
              if (!clientDoc.exists) {
                missingDocs.push({
                  email: userEmail,
                  id: doc.id,
                  role: userRole,
                  missing: '住 拽 (住)'
                });
              }
            } else if (userRole === USER_ROLES.ADMIN) {
              const clientDoc = await db.collection('clients').doc(doc.id).get();
              
              if (!clientDoc.exists) {
                missingDocs.push({
                  email: userEmail,
                  id: doc.id,
                  role: userRole,
                  missing: '住 拽 ()'
                });
              }
            }
          }
          
          // Display results
          if (missingDocs.length === 0) {
            missingUsersList.innerHTML = '<p style="color: green;"> 爪 砖转砖 注 住 住专!</p>';
          } else {
            let html = `<p style="color: orange;">爪 ${missingDocs.length} 砖转砖 注 住 住专:</p>`;
            html += '<ul>';
            
            missingDocs.forEach(user => {
              html += `<li>
                ${user.email} (${getRoleDisplayName(user.role)}) - 住专 ${user.missing}
                <button class="btn btn-sm btn-info recover-specific-user-btn" 
                  data-id="${user.id}" 
                  data-email="${user.email}" 
                  data-role="${user.role}">
                  砖专
                </button>
              </li>`;
            });
            
            html += '</ul>';
            missingUsersList.innerHTML = html;
            
            // Add recovery buttons
            document.querySelectorAll('.recover-specific-user-btn').forEach(btn => {
              btn.addEventListener('click', async () => {
                const userId = btn.dataset.id;
                const userEmail = btn.dataset.email;
                const userRole = btn.dataset.role;
                
                try {
                  await recoverSpecificUser(userId, userEmail, userRole);
                  btn.disabled = true;
                  btn.textContent = '砖专';
                  btn.classList.remove('btn-info');
                  btn.classList.add('btn-success');
                } catch (error) {
                  console.error('Error recovering specific user:', error);
                  alert(`砖 砖专 砖转砖: ${error.message}`);
                }
              });
            });
          }
        } catch (error) {
          console.error('Error scanning users:', error);
          missingUsersList.innerHTML = `<p style="color: red;">砖 住专拽转 砖转砖: ${error.message}</p>`;
        }
      }
      
      // Helper function to recover a specific user
      async function recoverSpecificUser(userId, email, role) {
        // Create the missing documents based on role
        if (role === USER_ROLES.CLIENT) {
          // Check if client document exists
          const clientDoc = await db.collection('clients').doc(userId).get();
          
          if (!clientDoc.exists) {
            // Need to find an agent
            const firstAgentSnapshot = await db.collection('users')
              .where('role', '==', USER_ROLES.AGENT)
              .limit(1)
              .get();
            
            let agentId = null;
            
            if (!firstAgentSnapshot.empty) {
              agentId = firstAgentSnapshot.docs[0].id;
            }
            
            // Create client document
            const clientData = {
              email: email,
              allowedBrands: [],
              likes: [],
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            if (agentId) {
              clientData.agentId = agentId;
              
              // Update agent's client list
              await db.collection('agents').doc(agentId).update({
                clients: firebase.firestore.FieldValue.arrayUnion(userId)
              }).catch(error => {
                console.error('Error updating agent\'s client list:', error);
              });
            }
            
            await db.collection('clients').doc(userId).set(clientData);
          }
        } else if (role === USER_ROLES.AGENT) {
          // Check if agent document exists
          const agentDoc = await db.collection('agents').doc(userId).get();
          
          if (!agentDoc.exists) {
            // Create agent document
            await db.collection('agents').doc(userId).set({
              email: email,
              clients: [],
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
          }
          
          // Check if client document exists
          const clientDoc = await db.collection('clients').doc(userId).get();
          
          if (!clientDoc.exists) {
            // Create client document
            await db.collection('clients').doc(userId).set({
              email: email,
              allowedBrands: [],
              likes: [],
              agentId: userId, // Agents are their own agents
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
          }
        } else if (role === USER_ROLES.ADMIN) {
          // Check if client document exists
          const clientDoc = await db.collection('clients').doc(userId).get();
          
          if (!clientDoc.exists) {
            // Create client document
            await db.collection('clients').doc(userId).set({
              email: email,
              allowedBrands: [],
              likes: [],
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
          }
        }
        
        return true;
      }
      
      // Helper function to get role display name
      function getRoleDisplayName(role) {
        switch (role) {
          case USER_ROLES.ADMIN:
            return '';
          case USER_ROLES.AGENT:
            return '住';
          case USER_ROLES.CLIENT:
            return '拽';
          default:
            return role;
        }
      }
    });
  </script>

  <!-- Notification System Script -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Get DOM elements
      const notificationButton = document.getElementById('notification-button');
      const notificationCount = document.getElementById('notification-count');
      const notificationDropdown = document.getElementById('notification-dropdown');
      const notificationList = document.getElementById('notification-list');
      const markAllReadButton = document.getElementById('mark-all-read');

      // Notification data
      let notifications = [];
      let unreadCount = 0;

      // Toggle notification dropdown
      notificationButton.addEventListener('click', () => {
        notificationDropdown.classList.toggle('show');
      });

      // Close dropdown when clicking outside
      document.addEventListener('click', (event) => {
        if (!notificationButton.contains(event.target) && !notificationDropdown.contains(event.target)) {
          notificationDropdown.classList.remove('show');
        }
      });

      // Mark all notifications as read
      markAllReadButton.addEventListener('click', async () => {
        try {
          const user = auth.currentUser;
          if (!user) return;

          const batch = db.batch();

          // Get all unread notifications
          const unreadNotifications = await db.collection('notifications')
            .where('recipientId', '==', user.uid)
            .where('read', '==', false)
            .get();

          // Mark all as read in a batch
          unreadNotifications.forEach(doc => {
            batch.update(doc.ref, { read: true });
          });

          await batch.commit();

          // Update UI
          document.querySelectorAll('.notification-item.unread').forEach(item => {
            item.classList.remove('unread');
          });

          unreadCount = 0;
          updateNotificationCount();

        } catch (error) {
          console.error('Error marking all as read:', error);
        }
      });

      // Update notification count badge
      function updateNotificationCount() {
        if (unreadCount > 0) {
          notificationCount.textContent = unreadCount;
          notificationCount.style.display = 'flex';
        } else {
          notificationCount.style.display = 'none';
        }
      }

      // Format timestamp to relative time
      function formatTimeAgo(timestamp) {
        if (!timestamp) return '';

        const now = new Date();
        const date = timestamp.toDate();
        const diffMs = now - date;
        const diffSec = Math.floor(diffMs / 1000);
        const diffMin = Math.floor(diffSec / 60);
        const diffHour = Math.floor(diffMin / 60);
        const diffDay = Math.floor(diffHour / 24);

        if (diffSec < 60) {
          return '专注';
        } else if (diffMin < 60) {
          return `驻 ${diffMin} 拽'`;
        } else if (diffHour < 24) {
          return `驻 ${diffHour} 砖注转`;
        } else if (diffDay < 7) {
          return `驻 ${diffDay} `;
        } else {
          return date.toLocaleDateString('he-IL');
        }
      }

      // Create notification item element
      function createNotificationItem(notification) {
        const item = document.createElement('div');
        item.className = `notification-item ${notification.read ? '' : 'unread'}`;
        item.dataset.id = notification.id;

        item.innerHTML = `
          <div class="notification-content">
            <div>${notification.message}</div>
            <div class="notification-time">${formatTimeAgo(notification.createdAt)}</div>
          </div>
        `;

        // Add click event for notification
        item.addEventListener('click', async () => {
          // Mark as read if unread
          if (!notification.read) {
            try {
              await db.collection('notifications').doc(notification.id).update({
                read: true
              });

              // Update UI
              item.classList.remove('unread');
              unreadCount--;
              updateNotificationCount();

            } catch (error) {
              console.error('Error marking notification as read:', error);
            }
          }

          // If it's an order notification, navigate to the orders page
          if (notification.type === 'new_order' && notification.orderId) {
            window.location.href = 'orders-admin.html';
          }
        });

        return item;
      }

      // Load notifications from Firestore
      async function loadNotifications() {
        try {
          const user = auth.currentUser;
          if (!user) {
            console.log('No user logged in');
            return;
          }

          console.log('Loading notifications for user:', user.uid);

          // Clear previous notifications
          notificationList.innerHTML = '<div style="text-align: center; padding: 10px;">注 转专转...</div>';

          // Get notifications for this user
          console.log('Executing query for notifications where recipientId =', user.uid);
          const notificationsSnapshot = await db.collection('notifications')
            .where('recipientId', '==', user.uid)
            .orderBy('createdAt', 'desc')
            .limit(20)
            .get();

          console.log(`Query returned ${notificationsSnapshot.size} notifications`);

          if (notificationsSnapshot.empty) {
            console.log('No notifications found');
            notificationList.innerHTML = '<div class="notification-empty"> 转专转</div>';
            unreadCount = 0;
          } else {
            notifications = [];
            unreadCount = 0;
            notificationList.innerHTML = ''; // Clear loading message

            notificationsSnapshot.forEach(doc => {
              console.log('Processing notification:', doc.id);
              const notificationData = doc.data();
              console.log('Notification data:', notificationData);
              
              const notification = {
                id: doc.id,
                ...notificationData
              };

              notifications.push(notification);

              // Count unread notifications
              if (!notification.read) {
                unreadCount++;
              }

              // Create and append notification item
              const notificationItem = createNotificationItem(notification);
              notificationList.appendChild(notificationItem);
            });
            
            console.log(`Processed ${notifications.length} notifications, ${unreadCount} unread`);
          }

          // Update notification count
          updateNotificationCount();

        } catch (error) {
          console.error('Error loading notifications:', error);
          console.error('Error details:', error.code, error.message, error.details);
          notificationList.innerHTML = `<div class="notification-error">砖 注转 转专转: ${error.message}</div>`;
          
          // Check if this is an indexing error
          if (error.code === 'failed-precondition' || error.message.includes('index')) {
            notificationList.innerHTML += `<div style="margin-top: 10px">
              <p>专砖 拽住 驻专住专.  爪专 转 拽住 :</p>
              <p>Collection: notifications</p>
              <p>Fields: recipientId (ascending), createdAt (descending)</p>
              <a href="https://console.firebase.google.com/project/agatd-e37c7/firestore/indexes" target="_blank">驻转 专转 拽住 驻专住专</a>
            </div>`;
          }
        }
      }
      
      // Debug function to manually check for notifications
      async function debugCheckNotifications() {
        try {
          const user = auth.currentUser;
          if (!user) {
            console.error('No user logged in');
            return;
          }
          
          console.log('Debug: Checking for notifications...');
          
          // Look at all notifications in the database to debug
          const allNotificationsSnapshot = await db.collection('notifications').get();
          console.log(`Debug: Found ${allNotificationsSnapshot.size} total notifications in the database`);
          
          // Log each notification
          allNotificationsSnapshot.forEach(doc => {
            const data = doc.data();
            console.log(`Notification ${doc.id}:`, {
              recipientId: data.recipientId,
              message: data.message,
              type: data.type,
              read: data.read,
              createdAt: data.createdAt ? data.createdAt.toDate() : null,
              agentId: data.agentId,
              senderId: data.senderId,
              matches: data.recipientId === user.uid
            });
          });
          
          // Check specifically for admin notifications
          const adminNotifications = await db.collection('notifications')
            .where('recipientId', '==', user.uid)
            .get();
            
          console.log(`Debug: Found ${adminNotifications.size} notifications specifically for this admin (${user.uid})`);
          
          // Refresh notifications display
          loadNotifications();
          
          return {
            totalNotifications: allNotificationsSnapshot.size,
            adminNotifications: adminNotifications.size,
            userId: user.uid
          };
        } catch (error) {
          console.error('Debug error:', error);
          return { error: error.message };
        }
      }
      
      // Add debug button
      const addDebugButton = () => {
        const debugButtonContainer = document.createElement('div');
        debugButtonContainer.style.position = 'fixed';
        debugButtonContainer.style.bottom = '10px';
        debugButtonContainer.style.right = '10px';
        debugButtonContainer.style.zIndex = '9999';
        
        const debugButton = document.createElement('button');
        debugButton.textContent = '拽 转专转';
        debugButton.style.padding = '8px 16px';
        debugButton.style.backgroundColor = '#ff5722';
        debugButton.style.color = 'white';
        debugButton.style.border = 'none';
        debugButton.style.borderRadius = '4px';
        debugButton.style.cursor = 'pointer';
        
        debugButton.addEventListener('click', async () => {
          console.log('Debug button clicked');
          const results = await debugCheckNotifications();
          alert(`拽转 转专转: ${JSON.stringify(results, null, 2)}`);
        });
        
        debugButtonContainer.appendChild(debugButton);
        document.body.appendChild(debugButtonContainer);
      };
      
      // Add debug button after page load
      window.addEventListener('load', addDebugButton);

      // Listen for auth state changes
      auth.onAuthStateChanged(user => {
        if (user) {
          // Load notifications
          loadNotifications();

          // Set up real-time listener for new notifications
          const unsubscribe = db.collection('notifications')
            .where('recipientId', '==', user.uid)
            .where('read', '==', false)
            .onSnapshot(snapshot => {
              // Check for added notifications
              const changes = snapshot.docChanges();

              let newNotifications = false;

              changes.forEach(change => {
                if (change.type === 'added') {
                  newNotifications = true;
                  unreadCount++;

                  // Get the notification data
                  const notification = {
                    id: change.doc.id,
                    ...change.doc.data()
                  };

                  // Add to the beginning of the list
                  const notificationItem = createNotificationItem(notification);
                  notificationList.insertBefore(notificationItem, notificationList.firstChild);

                  // Remove empty notification message if present
                  const emptyMessage = notificationList.querySelector('.notification-empty');
                  if (emptyMessage) {
                    notificationList.removeChild(emptyMessage);
                  }
                }
              });

              if (newNotifications) {
                // Play notification sound
                // const notificationSound = new Audio('path/to/notification-sound.mp3');
                // notificationSound.play();

                // Update notification count
                updateNotificationCount();
              }
            });

          // Store the unsubscribe function
          window.notificationsUnsubscribe = unsubscribe;
        } else {
          // User is logged out, unsubscribe from notifications
          if (window.notificationsUnsubscribe) {
            window.notificationsUnsubscribe();
          }
        }
      });
    });
  </script>
</body>
</html>